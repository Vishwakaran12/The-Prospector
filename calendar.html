<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Prospector - Calendar</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --cyber-bg: #0a0a0a;
            --cyber-bg-secondary: #1a1a1a;
            --cyber-blue: #00d4ff;
            --cyber-green: #00ff88;
            --cyber-pink: #ff00aa;
            --cyber-orange: #ff6600;
            --cyber-purple: #aa00ff;
            --cyber-text: #ffffff;
            --cyber-text-dim: #cccccc;
            --cyber-border: #333333;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, var(--cyber-bg) 0%, #1a1a2e 50%, #16213e 100%);
            color: var(--cyber-text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .calendar-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .calendar-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--cyber-blue);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .calendar-header h1 {
            font-size: 2.5rem;
            color: var(--cyber-blue);
            text-shadow: 0 0 20px var(--cyber-blue);
            margin-bottom: 10px;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(45deg, #5c1a4f, #752d6a);
            border: 1px solid var(--cyber-pink);
            color: var(--cyber-pink);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .back-button:hover {
            background: linear-gradient(45deg, #752d6a, #8f3a7a);
            box-shadow: 0 0 15px var(--cyber-pink);
            transform: translateY(-2px);
        }

        .cyber-button {
            background: linear-gradient(45deg, #1a4f5c, #2d6a75);
            border: 1px solid var(--cyber-blue);
            color: var(--cyber-blue);
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .cyber-button:hover {
            background: linear-gradient(45deg, #2d6a75, #3a7a85);
            box-shadow: 0 0 15px var(--cyber-blue);
            transform: translateY(-2px);
        }

        .calendar-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-top: 20px;
        }

        .calendar-sidebar {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid var(--cyber-border);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .calendar-main {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid var(--cyber-border);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .section-title {
            color: var(--cyber-green);
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .auth-status {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--cyber-blue);
            border-radius: 5px;
            text-align: center;
        }

        .calendar-widget {
            margin-top: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--cyber-border);
            border-radius: 5px;
            overflow: hidden;
        }

        .calendar-day {
            background: var(--cyber-bg-secondary);
            padding: 10px;
            text-align: center;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .calendar-day.today {
            background: var(--cyber-blue);
            color: var(--cyber-bg);
            font-weight: bold;
        }

        .calendar-day.has-event {
            background: rgba(0, 255, 136, 0.3);
            border: 1px solid var(--cyber-green);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: var(--cyber-text-dim);
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--cyber-border);
            border-radius: 3px;
            color: var(--cyber-text);
            font-family: 'Share Tech Mono', monospace;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--cyber-blue);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .event-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--cyber-border);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .event-title {
            color: var(--cyber-green);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .event-time {
            color: var(--cyber-text-dim);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .calendar-content {
                grid-template-columns: 1fr;
            }
            
            .calendar-header h1 {
                font-size: 1.8rem;
            }
            
            .back-button {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <a href="simple-app.html" class="back-button">‚Üê Back to Prospector</a>
    
    <div class="calendar-container">
        <div class="calendar-header">
            <h1>üìÖ Google Calendar</h1>
            <p>Manage your events with cyberpunk style</p>
        </div>

        <div class="calendar-content">
            <!-- Sidebar -->
            <div class="calendar-sidebar">
                <!-- Authentication Status -->
                <div class="section-title">üîê Authentication</div>
                <div id="calendarAuthStatus" class="auth-status">
                    üìÖ Sign in to Google to access your calendars
                </div>
                <div id="calendarAuthButtons" style="text-align: center;">
                    <button id="signInButton" onclick="signInToGoogle()" class="cyber-button">
                        üîó Connect Google Calendar
                    </button>
                    <button id="signOutButton" onclick="signOutFromGoogle()" class="cyber-button" 
                            style="background: linear-gradient(45deg, #5c1a4f, #752d6a); border: 1px solid #ff00aa; color: #ff00aa; display: none;">
                        üö™ Disconnect Calendar
                    </button>
                </div>

                <!-- Calendar List -->
                <div id="calendarList" style="display: none;">
                    <div class="section-title">üìã Your Calendars</div>
                    <div id="calendarListContent"></div>
                </div>

                <!-- Quick Add from Starred Items -->
                <div id="quickAddSection" style="display: none;">
                    <div class="section-title">‚≠ê Quick Add Starred Items</div>
                    <div class="form-group">
                        <label>Select Starred Item to Add</label>
                        <select id="starredItemsDropdown" onchange="selectStarredItem()">
                            <option value="">Choose a starred item...</option>
                        </select>
                    </div>
                    <div id="selectedItemPreview" style="display: none; margin: 10px 0; padding: 10px; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--cyber-green); border-radius: 5px;">
                        <div style="font-size: 0.9rem; color: var(--cyber-green); margin-bottom: 5px;">Selected Item:</div>
                        <div id="previewTitle" style="color: var(--cyber-blue); font-weight: bold;"></div>
                        <div id="previewDescription" style="color: var(--cyber-text-dim); font-size: 0.8rem; margin: 5px 0;"></div>
                        <div id="previewLink" style="color: var(--cyber-green); font-size: 0.8rem;"></div>
                        <div style="margin-top: 10px;">
                            <label style="color: var(--cyber-text-dim); font-size: 0.8rem;">Event Date & Time:</label>
                            <input type="datetime-local" id="quickEventDateTime" style="width: 100%; margin-top: 5px;">
                        </div>
                        <button type="button" onclick="addSelectedToCalendar()" class="cyber-button" style="width: 100%; margin-top: 10px;">
                            ‚ûï Add to Google Calendar
                        </button>
                    </div>
                </div>

                <!-- Event Form -->
                <div id="eventForm" style="display: none;">
                    <div class="section-title">‚ûï Create Event</div>
                    <form onsubmit="createCalendarEvent(event)">
                        <div class="form-group">
                            <label>Event Title</label>
                            <input type="text" id="eventTitle" required>
                        </div>
                        <div class="form-group">
                            <label>Start Date & Time</label>
                            <input type="datetime-local" id="eventStart" required>
                        </div>
                        <div class="form-group">
                            <label>End Date & Time</label>
                            <input type="datetime-local" id="eventEnd" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="eventDescription" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Calendar</label>
                            <select id="eventCalendar">
                                <option value="primary">Primary Calendar</option>
                            </select>
                        </div>
                        <button type="submit" class="cyber-button" style="width: 100%;">
                            Create Event
                        </button>
                    </form>
                </div>
            </div>

            <!-- Main Calendar -->
            <div class="calendar-main">
                <div class="section-title">üìÖ Calendar View</div>
                
                <!-- Calendar Widget -->
                <div id="calendarWidget">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button onclick="changeMonth(-1)" class="cyber-button">‚Üê Previous</button>
                        <h3 id="currentMonth" style="color: var(--cyber-blue);">Loading...</h3>
                        <button onclick="changeMonth(1)" class="cyber-button">Next ‚Üí</button>
                    </div>
                    
                    <div class="calendar-grid">
                        <div class="calendar-day" style="background: var(--cyber-blue); color: var(--cyber-bg); font-weight: bold;">Sun</div>
                        <div class="calendar-day" style="background: var(--cyber-blue); color: var(--cyber-bg); font-weight: bold;">Mon</div>
                        <div class="calendar-day" style="background: var(--cyber-blue); color: var(--cyber-bg); font-weight: bold;">Tue</div>
                        <div class="calendar-day" style="background: var(--cyber-blue); color: var(--cyber-bg); font-weight: bold;">Wed</div>
                        <div class="calendar-day" style="background: var(--cyber-blue); color: var(--cyber-bg); font-weight: bold;">Thu</div>
                        <div class="calendar-day" style="background: var(--cyber-blue); color: var(--cyber-bg); font-weight: bold;">Fri</div>
                        <div class="calendar-day" style="background: var(--cyber-blue); color: var(--cyber-bg); font-weight: bold;">Sat</div>
                        <!-- Calendar days will be generated by JavaScript and appended here -->
                    </div>
                </div>

                <!-- Events List -->
                <div id="eventsSection" style="display: none;">
                    <div class="section-title">üìã Upcoming Events</div>
                    <div id="eventsList" class="events-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration - same as main app
        const API_CONFIG = {
            googleCalendar: {
                apiKey: 'AIzaSyDet8FIQM8OnoPdhhVoR6_4NfuiKynBHoE',
                clientId: '1012494277929-nkdc974uqvstuoqmd9b41cuotn1cb8uq.apps.googleusercontent.com',
                discoveryDoc: 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
                scopes: 'https://www.googleapis.com/auth/calendar'
            }
        };

        // Calendar state
        let isGoogleApiLoaded = false;
        let isGoogleSignedIn = false;
        let isInitializing = false;
        let googleCalendars = [];
        let accessToken = null;
        let currentDate = new Date();
        let calendarEvents = [];

        // Persistent Google auth functions
        function saveGoogleAuthState(token) {
            if (token) {
                localStorage.setItem('googleAccessToken', token);
                localStorage.setItem('googleSignedIn', 'true');
                localStorage.setItem('googleAuthTime', Date.now().toString());
            }
        }

        function loadGoogleAuthState() {
            const token = localStorage.getItem('googleAccessToken');
            const signedIn = localStorage.getItem('googleSignedIn') === 'true';
            const authTime = localStorage.getItem('googleAuthTime');
            
            // Check if token is not too old (24 hours)
            if (token && signedIn && authTime) {
                const timeElapsed = Date.now() - parseInt(authTime);
                const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                
                if (timeElapsed < maxAge) {
                    accessToken = token;
                    isGoogleSignedIn = true;
                    
                    // Set the token in gapi if available
                    if (typeof gapi !== 'undefined' && gapi.client) {
                        gapi.client.setToken({access_token: accessToken});
                    }
                    
                    console.log('Restored Google auth session');
                    return true;
                }
            }
            
            // Clear expired auth
            clearGoogleAuthState();
            return false;
        }

        function clearGoogleAuthState() {
            localStorage.removeItem('googleAccessToken');
            localStorage.removeItem('googleSignedIn');
            localStorage.removeItem('googleAuthTime');
            accessToken = null;
            isGoogleSignedIn = false;
        }

        // Initialize Google APIs
        async function initializeGoogleApis() {
            if (isGoogleApiLoaded) {
                console.log('Google APIs already loaded');
                return;
            }
            
            if (isInitializing) {
                console.log('Google APIs already initializing, waiting...');
                while (isInitializing && !isGoogleApiLoaded) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                return;
            }

            isInitializing = true;

            try {
                // Validate API credentials
                if (!API_CONFIG.googleCalendar.apiKey) {
                    throw new Error('Google Calendar API key not configured.');
                }
                
                if (!API_CONFIG.googleCalendar.clientId) {
                    throw new Error('Google Calendar Client ID not configured.');
                }

                // If gapi isn't present, dynamically load it
                if (typeof gapi === 'undefined') {
                    console.log('Loading Google APIs...');
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://apis.google.com/js/api.js';
                        script.async = true;
                        script.defer = true;
                        script.onload = () => resolve();
                        script.onerror = () => reject(new Error('Failed to load Google APIs'));
                        document.head.appendChild(script);
                    });
                }

                console.log('Initializing Google APIs...');

                // Load only the client library
                await new Promise((resolve, reject) => {
                    if (!gapi || !gapi.load) return reject(new Error('gapi.load not available'));
                    gapi.load('client', {
                        callback: resolve,
                        onerror: reject
                    });
                });
                
                // Initialize the client with API key only
                await gapi.client.init({
                    apiKey: API_CONFIG.googleCalendar.apiKey,
                    discoveryDocs: [API_CONFIG.googleCalendar.discoveryDoc]
                });
                
                // Initialize Google Identity Services for OAuth
                if (typeof google !== 'undefined' && google.accounts) {
                    window.googleTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: API_CONFIG.googleCalendar.clientId,
                        scope: API_CONFIG.googleCalendar.scopes,
                        callback: async (response) => {
                            if (response.access_token) {
                                accessToken = response.access_token;
                                gapi.client.setToken({access_token: accessToken});
                                isGoogleSignedIn = true;
                                
                                // Save auth state for persistence
                                saveGoogleAuthState(accessToken);
                                
                                console.log('Google OAuth successful');
                                await updateCalendarUI();
                                await loadGoogleCalendars();
                            }
                        }
                    });
                }
                
                isGoogleApiLoaded = true;
                console.log('Google APIs initialized successfully');
                
                await updateCalendarUI();
                
            } catch (error) {
                console.error('Error initializing Google APIs:', error);
                
                const authStatusDiv = document.getElementById('calendarAuthStatus');
                if (authStatusDiv) {
                    authStatusDiv.innerHTML = `
                        <div style="color: var(--cyber-pink);">
                            ‚ùå Failed to initialize Google Calendar API
                            <br><small>Check console for more details.</small>
                        </div>
                    `;
                }
            } finally {
                isInitializing = false;
            }
        }

        // Sign in to Google
        async function signInToGoogle() {
            try {
                if (!isGoogleApiLoaded) {
                    await initializeGoogleApis();
                }
                
                if (!window.googleTokenClient) {
                    throw new Error('Google Token Client not initialized');
                }
                
                window.googleTokenClient.requestAccessToken();
                console.log('Google sign-in initiated...');
                
            } catch (error) {
                console.error('Google sign-in failed:', error);
                
                const authStatusDiv = document.getElementById('calendarAuthStatus');
                if (authStatusDiv) {
                    authStatusDiv.innerHTML = `
                        <div style="color: var(--cyber-pink);">
                            ‚ùå Google sign-in failed: ${error.message}
                        </div>
                    `;
                }
            }
        }

        // Sign out from Google
        async function signOutFromGoogle() {
            try {
                if (accessToken) {
                    google.accounts.oauth2.revoke(accessToken);
                }
                
                gapi.client.setToken(null);
                
                // Clear auth state
                clearGoogleAuthState();
                
                googleCalendars = [];
                
                await updateCalendarUI();
                
                console.log('Google sign-out successful');
                
            } catch (error) {
                console.error('Google sign-out failed:', error);
            }
        }

        // Update Calendar UI
        async function updateCalendarUI() {
            const authStatusDiv = document.getElementById('calendarAuthStatus');
            const calendarListDiv = document.getElementById('calendarList');
            const eventFormDiv = document.getElementById('eventForm');
            const eventsSection = document.getElementById('eventsSection');
            
            if (!isGoogleApiLoaded) {
                authStatusDiv.innerHTML = `
                    <div style="color: var(--cyber-orange);">
                        üîÑ Initializing Google Calendar API...
                    </div>
                `;
                return;
            }
            
            if (isGoogleSignedIn) {
                authStatusDiv.innerHTML = `
                    <div style="color: var(--cyber-green);">
                        ‚úÖ Signed in to Google Calendar
                        <button onclick="signOutFromGoogle()" class="cyber-button" 
                                style="margin-left: 10px; padding: 5px 15px; font-size: 0.8rem; 
                                       background: linear-gradient(45deg, #5c1a4f, #752d6a); 
                                       border: 1px solid #ff00aa; color: #ff00aa;">
                            Sign Out
                        </button>
                    </div>
                `;
                
                calendarListDiv.style.display = 'block';
                eventFormDiv.style.display = 'block';
                eventsSection.style.display = 'block';
                
                await loadGoogleCalendars();
                await loadCalendarEventsForWidget();
                loadStarredItems(); // Load starred items when signed in
                
            } else {
                authStatusDiv.innerHTML = `
                    <div style="color: var(--cyber-blue);">
                        üìÖ Sign in to Google to access your calendars
                    </div>
                `;
                
                calendarListDiv.style.display = 'none';
                eventFormDiv.style.display = 'none';
                eventsSection.style.display = 'none';
                document.getElementById('quickAddSection').style.display = 'none'; // Hide starred items section
            }
        }

        // Load Google Calendars
        async function loadGoogleCalendars() {
            try {
                const response = await gapi.client.calendar.calendarList.list();
                googleCalendars = response.result.items || [];
                
                const calendarListContent = document.getElementById('calendarListContent');
                const eventCalendarSelect = document.getElementById('eventCalendar');
                
                calendarListContent.innerHTML = '';
                eventCalendarSelect.innerHTML = '';
                
                googleCalendars.forEach(calendar => {
                    // Add to sidebar list
                    const calendarDiv = document.createElement('div');
                    calendarDiv.style.cssText = 'margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;';
                    calendarDiv.innerHTML = `
                        <div style="color: var(--cyber-green); font-weight: bold;">${calendar.summary}</div>
                        <div style="color: var(--cyber-text-dim); font-size: 0.8rem;">${calendar.id}</div>
                    `;
                    calendarListContent.appendChild(calendarDiv);
                    
                    // Add to dropdown
                    const option = document.createElement('option');
                    option.value = calendar.id;
                    option.textContent = calendar.summary;
                    eventCalendarSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Failed to load calendars:', error);
            }
        }

        // Calendar widget functions
        function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            // Get the calendar grid and remove existing day cells (keep headers)
            const calendarGrid = document.querySelector('.calendar-grid');
            const existingDays = calendarGrid.querySelectorAll('.calendar-day:not([style*="background: var(--cyber-blue)"])');
            existingDays.forEach(day => day.remove());
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                emptyDay.style.opacity = '0.3';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const dayDate = new Date(year, month, day);
                
                // Highlight today
                if (dayDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Check for events on this day
                const hasEvent = calendarEvents.some(event => {
                    const eventDate = new Date(event.start.dateTime || event.start.date);
                    return eventDate.toDateString() === dayDate.toDateString();
                });
                
                if (hasEvent) {
                    dayElement.classList.add('has-event');
                }
                
                dayElement.onclick = () => showEventsForDay(dayDate);
                calendarGrid.appendChild(dayElement);
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
            if (isGoogleSignedIn) {
                loadCalendarEventsForWidget();
            }
        }

        function showEventsForDay(date) {
            const dayEvents = calendarEvents.filter(event => {
                const eventDate = new Date(event.start.dateTime || event.start.date);
                return eventDate.toDateString() === date.toDateString();
            });
            
            if (dayEvents.length > 0) {
                const eventsList = dayEvents.map(event => 
                    `<div class="event-item">
                        <div class="event-title">${event.summary}</div>
                        <div class="event-time">${new Date(event.start.dateTime || event.start.date).toLocaleString()}</div>
                    </div>`
                ).join('');
                
                document.getElementById('eventsList').innerHTML = eventsList;
            } else {
                document.getElementById('eventsList').innerHTML = `
                    <div style="color: var(--cyber-text-dim); text-align: center; padding: 20px;">
                        No events on ${date.toDateString()}
                    </div>
                `;
            }
        }

        // Load calendar events
        async function loadCalendarEventsForWidget() {
            if (!isGoogleSignedIn) return;
            
            try {
                const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
                const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString();
                
                const response = await gapi.client.calendar.events.list({
                    calendarId: 'primary',
                    timeMin: timeMin,
                    timeMax: timeMax,
                    singleEvents: true,
                    orderBy: 'startTime'
                });
                
                calendarEvents = response.result.items || [];
                generateCalendar();
                
            } catch (error) {
                console.error('Failed to load calendar events:', error);
            }
        }

        // Create calendar event
        async function createCalendarEvent(event) {
            event.preventDefault();
            
            if (!isGoogleSignedIn) {
                alert('Please sign in to Google Calendar first');
                return;
            }
            
            try {
                const eventData = {
                    summary: document.getElementById('eventTitle').value,
                    description: document.getElementById('eventDescription').value,
                    start: {
                        dateTime: document.getElementById('eventStart').value,
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    end: {
                        dateTime: document.getElementById('eventEnd').value,
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    }
                };
                
                const calendarId = document.getElementById('eventCalendar').value;
                
                await gapi.client.calendar.events.insert({
                    calendarId: calendarId,
                    resource: eventData
                });
                
                alert('Event created successfully!');
                document.querySelector('#eventForm form').reset();
                await loadCalendarEventsForWidget();
                
            } catch (error) {
                console.error('Failed to create event:', error);
                alert('Failed to create event. Please try again.');
            }
        }

        // Starred Items Management
        function loadStarredItems() {
            const starredItems = JSON.parse(localStorage.getItem('starredItems') || '[]');
            const dropdown = document.getElementById('starredItemsDropdown');
            
            // Clear existing options except the first one
            dropdown.innerHTML = '<option value="">Choose a starred item...</option>';
            
            if (starredItems.length === 0) {
                dropdown.innerHTML += '<option value="" disabled>No starred items found</option>';
                return;
            }
            
            starredItems.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = item.title || `Starred Item ${index + 1}`;
                dropdown.appendChild(option);
            });
            
            // Show/hide the quick add section based on starred items
            const quickAddSection = document.getElementById('quickAddSection');
            if (starredItems.length > 0 && isGoogleSignedIn) {
                quickAddSection.style.display = 'block';
            } else {
                quickAddSection.style.display = 'none';
            }
        }
        
        function selectStarredItem() {
            const dropdown = document.getElementById('starredItemsDropdown');
            const selectedIndex = dropdown.value;
            const preview = document.getElementById('selectedItemPreview');
            
            if (selectedIndex === '') {
                preview.style.display = 'none';
                return;
            }
            
            const starredItems = JSON.parse(localStorage.getItem('starredItems') || '[]');
            const item = starredItems[selectedIndex];
            
            if (item) {
                document.getElementById('previewTitle').textContent = item.title || 'Untitled';
                document.getElementById('previewDescription').textContent = item.description || 'No description';
                document.getElementById('previewLink').textContent = item.link || '';
                
                // Set default date/time to now + 1 hour
                const now = new Date();
                now.setHours(now.getHours() + 1);
                document.getElementById('quickEventDateTime').value = now.toISOString().slice(0, 16);
                
                preview.style.display = 'block';
            }
        }
        
        async function addSelectedToCalendar() {
            const dropdown = document.getElementById('starredItemsDropdown');
            const selectedIndex = dropdown.value;
            const dateTimeInput = document.getElementById('quickEventDateTime');
            
            if (selectedIndex === '' || !dateTimeInput.value) {
                alert('Please select a starred item and specify date/time');
                return;
            }
            
            if (!isGoogleSignedIn) {
                alert('Please sign in to Google Calendar first');
                return;
            }
            
            const starredItems = JSON.parse(localStorage.getItem('starredItems') || '[]');
            const item = starredItems[selectedIndex];
            
            try {
                const startDateTime = new Date(dateTimeInput.value);
                const endDateTime = new Date(startDateTime.getTime() + 60 * 60 * 1000); // +1 hour
                
                let eventDescription = item.description || '';
                if (item.link) {
                    eventDescription += `\n\nSource: ${item.link}`;
                }
                eventDescription += `\n\n‚≠ê Added from The Prospector starred items`;
                
                const eventData = {
                    summary: `‚≠ê ${item.title}`,
                    description: eventDescription,
                    start: {
                        dateTime: startDateTime.toISOString(),
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    end: {
                        dateTime: endDateTime.toISOString(),
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    }
                };
                
                await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: eventData
                });
                
                alert('Starred item added to Google Calendar successfully!');
                
                // Reset the form
                dropdown.value = '';
                document.getElementById('selectedItemPreview').style.display = 'none';
                
                // Reload calendar events
                await loadCalendarEventsForWidget();
                
            } catch (error) {
                console.error('Failed to add starred item to calendar:', error);
                alert('Failed to add item to calendar. Please try again.');
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Calendar page loaded');
            generateCalendar();
            
            // Check for saved Google auth state
            const hasAuth = loadGoogleAuthState();
            
            await initializeGoogleApis();
            
            // If we had saved auth, update UI immediately
            if (hasAuth && isGoogleSignedIn) {
                await updateCalendarUI();
                await loadGoogleCalendars();
            }
            
            // Load starred items
            loadStarredItems();
        });
    </script>
</body>
</html>
