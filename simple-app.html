<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Prospector - Cyberpunk Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --cyber-blue: #00ffff;
            --cyber-pink: #ff0080;
            --cyber-green: #00ff41;
            --cyber-orange: #ff6b00;
            --cyber-purple: #8b00ff;
            --dark-bg: #0a0a0a;
            --darker-bg: #050505;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--dark-bg);
            color: var(--cyber-blue);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Animated Grid Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            z-index: -2;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* Particle Effects */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--cyber-blue);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { 
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .title {
            font-family: 'Orbitron', monospace;
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--cyber-blue), var(--cyber-pink), var(--cyber-green));
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            margin-bottom: 10px;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--cyber-green);
            text-transform: uppercase;
            letter-spacing: 3px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .search-section {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 255, 255, 0.1));
            border: 2px solid var(--cyber-blue);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .search-section::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--cyber-blue), var(--cyber-pink), var(--cyber-green), var(--cyber-orange));
            border-radius: 15px;
            z-index: -1;
            animation: borderGlow 3s linear infinite;
        }

        @keyframes borderGlow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .cyber-input {
            flex: 1;
            min-width: 250px;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--cyber-blue);
            border-radius: 10px;
            color: var(--cyber-blue);
            font-family: 'Share Tech Mono', monospace;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .cyber-input:focus {
            outline: none;
            border-color: var(--cyber-pink);
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
            transform: translateY(-2px);
        }

        .cyber-button {
            padding: 15px 30px;
            background: linear-gradient(45deg, var(--cyber-blue), var(--cyber-green));
            border: none;
            border-radius: 10px;
            color: black;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .cyber-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .cyber-button:hover::before {
            left: 100%;
        }

        .cyber-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 255, 255, 0.4);
        }

        .results-section {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--cyber-green);
            border-radius: 15px;
            padding: 30px;
            min-height: 300px;
        }

        .results-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            color: var(--cyber-green);
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .result-item {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 128, 0.05));
            border: 1px solid var(--cyber-blue);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .result-item:hover {
            transform: translateX(10px);
            border-color: var(--cyber-pink);
            box-shadow: -5px 0 15px rgba(255, 0, 128, 0.3);
        }

        .result-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: var(--cyber-blue);
            margin-bottom: 10px;
        }

        .result-link {
            color: var(--cyber-green);
            text-decoration: none;
            word-break: break-all;
            transition: color 0.3s ease;
        }

        .result-link:hover {
            color: var(--cyber-pink);
            text-shadow: 0 0 5px rgba(255, 0, 128, 0.5);
        }

        .result-snippet {
            color: #ccc;
            margin-top: 10px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
            color: var(--cyber-orange);
            animation: loadingPulse 1.5s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Glitch Effect */
        .glitch {
            position: relative;
            animation: glitch 2s infinite;
        }

        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }

        /* Burger Menu Styles */
        .burger-menu {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid var(--cyber-blue);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .burger-menu:hover {
            background: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 20px var(--cyber-blue);
        }

        .burger-line {
            width: 25px;
            height: 3px;
            background: var(--cyber-blue);
            margin: 5px 0;
            transition: 0.3s;
            border-radius: 2px;
        }

        .burger-menu.open .burger-line:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .burger-menu.open .burger-line:nth-child(2) {
            opacity: 0;
        }

        .burger-menu.open .burger-line:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(0, 20, 40, 0.95));
            border-right: 2px solid var(--cyber-blue);
            transition: left 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            padding: 80px 20px 20px 20px;
            backdrop-filter: blur(10px);
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-title {
            color: var(--cyber-blue);
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid var(--cyber-blue);
            padding-bottom: 10px;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            color: var(--cyber-orange);
            font-size: 1.1rem;
            margin-bottom: 15px;
            border-left: 3px solid var(--cyber-orange);
            padding-left: 10px;
        }

        .history-item {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid var(--cyber-blue);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .history-item:hover {
            background: rgba(0, 255, 255, 0.1);
            transform: translateX(5px);
            border-color: var(--cyber-green);
        }

        .history-content {
            flex: 1;
            min-width: 0;
        }

        .history-query {
            color: var(--cyber-blue);
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .history-date {
            color: #888;
            font-size: 0.8rem;
        }

        .history-results {
            color: var(--cyber-green);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .delete-btn {
            background: rgba(255, 0, 100, 0.2);
            border: 1px solid var(--cyber-pink);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .delete-btn:hover {
            background: rgba(255, 0, 100, 0.4);
            transform: scale(1.1);
            box-shadow: 0 0 10px var(--cyber-pink);
        }

        .delete-btn:active {
            transform: scale(0.95);
        }

        .preview-btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid var(--cyber-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            font-size: 0.8rem;
        }

        .preview-btn:hover {
            background: rgba(0, 255, 255, 0.4);
            transform: scale(1.1);
            box-shadow: 0 0 10px var(--cyber-blue);
        }

        .preview-btn:active {
            transform: scale(0.95);
        }

        /* Preview Modal Styles */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .preview-modal.show {
            display: flex;
        }

        .preview-content {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            border: 2px solid var(--cyber-blue);
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--cyber-blue);
        }

        .preview-close {
            background: rgba(255, 0, 100, 0.2);
            border: 1px solid var(--cyber-pink);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--cyber-pink);
            font-weight: bold;
        }

        .preview-close:hover {
            background: rgba(255, 0, 100, 0.4);
            transform: scale(1.1);
        }

        .preview-results {
            max-height: 60vh;
            overflow-y: auto;
        }

        .preview-result-item {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border-left: 4px solid var(--cyber-green);
        }

        /* Mode Button Styles */
        .mode-button {
            position: relative;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--cyber-blue);
            border-radius: 10px;
            color: var(--cyber-blue);
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 95px;
            max-width: 120px;
            flex: 1;
        }

        .mode-button:hover {
            transform: translateY(-2px);
            border-color: var(--cyber-pink);
            box-shadow: 0 5px 15px rgba(255, 0, 128, 0.3);
        }

        .mode-button.active {
            background: linear-gradient(45deg, var(--cyber-blue), var(--cyber-green));
            color: black;
            border-color: var(--cyber-green);
            animation: modePulse 2s ease-in-out infinite;
        }

        @keyframes modePulse {
            0%, 100% { box-shadow: 0 0 5px var(--cyber-green); }
            50% { box-shadow: 0 0 20px var(--cyber-green), 0 0 30px var(--cyber-blue); }
        }

        .mode-badge {
            font-size: 0.6rem;
            font-weight: 400;
            color: var(--cyber-orange);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 5px;
            border-radius: 6px;
            border: 1px solid var(--cyber-orange);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        .mode-button.active .mode-badge {
            color: var(--cyber-pink);
            border-color: var(--cyber-pink);
        }

        /* Search Mode Indicator */
        .mode-indicator {
            padding: 10px 15px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--cyber-blue);
            border-radius: 8px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .mode-indicator.detecting {
            animation: detecting 1.5s ease-in-out infinite;
        }

        @keyframes detecting {
            0%, 100% { background: rgba(0, 255, 255, 0.1); }
            50% { background: rgba(255, 107, 0, 0.2); }
        }

        .sidebar-stats {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid var(--cyber-orange);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: var(--cyber-orange);
            font-size: 0.9rem;
        }

        .clear-history-btn {
            background: linear-gradient(45deg, var(--cyber-pink), var(--cyber-orange));
            color: black;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
        }

        .clear-history-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--cyber-pink);
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 320px;
                left: -320px;
            }
            
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(0, 20, 40, 0.95), rgba(20, 0, 40, 0.95));
            border: 2px solid var(--cyber-blue);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3), inset 0 0 30px rgba(0, 255, 255, 0.1);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: var(--cyber-pink);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close:hover {
            color: var(--cyber-orange);
            transform: scale(1.2);
            text-shadow: 0 0 10px var(--cyber-orange);
        }

        .cyber-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--cyber-blue);
            border-radius: 8px;
            color: var(--text-color);
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .cyber-input:focus {
            outline: none;
            border-color: var(--cyber-green);
            box-shadow: 0 0 15px rgba(0, 255, 128, 0.3);
            background: rgba(0, 255, 128, 0.05);
        }

        .cyber-input:invalid {
            border-color: var(--cyber-pink);
        }

        .cyber-input::placeholder {
            color: #888;
        }
        /* Calendar Widget Styles */
        .calendar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid var(--cyber-blue);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            background: linear-gradient(45deg, var(--cyber-blue), var(--cyber-green));
            color: white;
            text-align: center;
            padding: 10px 5px;
            font-weight: bold;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            border-radius: 5px;
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 5px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: var(--cyber-blue);
            transform: scale(1.05);
        }

        .calendar-day.today {
            background: linear-gradient(45deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 128, 0.2));
            border-color: var(--cyber-pink);
            box-shadow: 0 0 10px rgba(255, 0, 128, 0.5);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            color: #666;
        }

        .calendar-day.has-events {
            background: linear-gradient(45deg, rgba(0, 255, 128, 0.2), rgba(255, 165, 0, 0.1));
            border-color: var(--cyber-green);
        }

        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--cyber-blue);
        }

        .calendar-event-banner {
            background: linear-gradient(45deg, var(--cyber-green), var(--cyber-blue));
            color: white;
            font-size: 0.7rem;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 255, 255, 0.3);
            animation: bannerGlow 3s ease-in-out infinite;
            border: 1px solid rgba(0, 255, 255, 0.5);
            font-family: 'Orbitron', monospace;
        }

        .calendar-event-banner:nth-child(even) {
            background: linear-gradient(45deg, var(--cyber-purple), var(--cyber-pink));
            box-shadow: 0 1px 3px rgba(255, 0, 128, 0.3);
            border-color: rgba(255, 0, 128, 0.5);
        }

        .calendar-event-banner:nth-child(3n) {
            background: linear-gradient(45deg, var(--cyber-orange), var(--cyber-green));
            box-shadow: 0 1px 3px rgba(255, 165, 0, 0.3);
            border-color: rgba(255, 165, 0, 0.5);
        }

        .calendar-event-banner:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        @keyframes bannerGlow {
            0%, 100% { 
                opacity: 0.8; 
                box-shadow: 0 1px 3px rgba(0, 255, 255, 0.3);
            }
            50% { 
                opacity: 1; 
                box-shadow: 0 2px 8px rgba(0, 255, 255, 0.6);
            }
        }

        .events-for-day {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid var(--cyber-blue);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .events-for-day h4 {
            color: var(--cyber-blue);
            font-family: 'Orbitron', monospace;
            margin-bottom: 15px;
        }

        .calendar-event-item {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 128, 0.05));
            border: 1px solid var(--cyber-green);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .calendar-event-item:hover {
            border-color: var(--cyber-pink);
            box-shadow: 0 0 10px rgba(255, 0, 128, 0.3);
        }

        .calendar-event-title {
            color: var(--cyber-green);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .calendar-event-time {
            color: var(--cyber-orange);
            font-size: 0.9rem;
        }

        .calendar-event-description {
            color: #ccc;
            font-size: 0.8rem;
            margin-top: 5px;
        }

    </style>
</head>
<body>
    <!-- Burger Menu -->
    <div class="burger-menu" onclick="toggleSidebar()">
        <div class="burger-line"></div>
        <div class="burger-line"></div>
        <div class="burger-line"></div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-title">üïµÔ∏è SEARCH HISTORY</div>
        
        <div class="sidebar-section">
            <div class="sidebar-stats">
                <div class="stat-item">
                    <span>Total Searches:</span>
                    <span id="totalSearches">0</span>
                </div>
                <div class="stat-item">
                    <span>Events Found:</span>
                    <span id="totalEvents">0</span>
                </div>
                <div class="stat-item">
                    <span>News Found:</span>
                    <span id="totalNews">0</span>
                </div>
            </div>
        </div>

        <div class="sidebar-section">
            <h3>üìù Recent Searches</h3>
            <div id="searchHistory">
                <!-- Search history will be populated here -->
            </div>
        </div>

        <div class="sidebar-section">
            <h3>‚≠ê Quick Actions</h3>
            <button class="clear-history-btn" onclick="openCalendarMode()" style="margin-bottom: 10px; background: linear-gradient(45deg, var(--cyber-green), var(--cyber-blue));">
                üìÖ Google Calendar
            </button>
            <button class="clear-history-btn" onclick="clearSearchHistory()">
                Clear History
            </button>
        </div>
    </div>

    <div class="particles" id="particles"></div>
    
    <div class="container">
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div>
                    <h1 class="title glitch">THE PROSPECTOR</h1>
                    <p class="subtitle">Community Event Discovery Network v3.0</p>
                </div>
                
                <!-- Authentication Section -->
                <div id="authSection" style="display: flex; gap: 10px; align-items: center;">
                    <!-- Login/Register buttons (shown when not authenticated) -->
                    <div id="guestControls" style="display: flex; gap: 10px;">
                        <button onclick="showLoginForm()" class="cyber-button" style="padding: 8px 15px; font-size: 0.9rem;">
                            üîê Login
                        </button>
                        <button onclick="showRegisterForm()" class="cyber-button" style="padding: 8px 15px; font-size: 0.9rem; background: linear-gradient(45deg, var(--cyber-pink), var(--cyber-blue));">
                            üë§ Register
                        </button>
                    </div>
                    
                    <!-- User info (shown when authenticated) -->
                    <div id="userControls" style="display: none; align-items: center; gap: 15px;">
                        <span id="userWelcome" style="color: var(--cyber-green); font-weight: bold;"></span>
                        <button onclick="showProfileForm()" class="cyber-button" style="padding: 8px 15px; font-size: 0.9rem;">
                            ‚öôÔ∏è Profile
                        </button>
                        <button onclick="logout()" class="cyber-button" style="padding: 8px 15px; font-size: 0.9rem; background: linear-gradient(45deg, var(--cyber-pink), #ff4444);">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Intelligent Search Mode Selector -->
        <section class="search-section" style="margin-bottom: 20px;">
            <h2 class="results-title" style="margin-bottom: 20px;">ü§ñ Intelligent Search Modes</h2>
            
            <!-- Search Mode Selector -->
            <div class="input-group" style="justify-content: center; margin-bottom: 20px;">
                <div style="display: flex; gap: 8px; flex-wrap: nowrap; width: 100%; justify-content: space-between; max-width: 800px;">
                    <button onclick="setSearchMode('auto')" class="mode-button active" id="autoMode">
                        ü§ñ Auto
                        <span class="mode-badge">Smart</span>
                    </button>
                    <button onclick="setSearchMode('events')" class="mode-button" id="eventsMode">
                        üìÖ Events
                        <span class="mode-badge">Local</span>
                    </button>
                    <button onclick="setSearchMode('github')" class="mode-button" id="githubMode">
                        üíª Code
                        <span class="mode-badge">GitHub</span>
                    </button>
                    <button onclick="setSearchMode('reddit')" class="mode-button" id="redditMode">
                        üí¨ Community
                        <span class="mode-badge">Reddit</span>
                    </button>
                    <button onclick="setSearchMode('news')" class="mode-button" id="newsMode">
                        üì∞ News
                        <span class="mode-badge">Latest</span>
                    </button>
                    <button onclick="setSearchMode('social')" class="mode-button" id="socialMode">
                        üåê Social
                        <span class="mode-badge">All</span>
                    </button>
                </div>
            </div>

            <!-- Universal Search Input -->
            <div class="input-group">
                <input type="text" id="universalSearchQuery" class="cyber-input" placeholder="Enter your search query - AI will detect the best mode..." required />
                <input type="text" id="universalLocationInput" class="cyber-input" placeholder="Location (for events mode)..." />
                <button onclick="performComprehensiveSearch()" class="cyber-button" id="searchButton">
                    üöÄ Smart Search
                </button>
            </div>
            
            <!-- Mode Indicator -->
            <div class="input-group" style="justify-content: center;">
                <div id="modeIndicator" style="color: var(--cyber-green); text-align: center; font-size: 0.9rem;">
                    ü§ñ Auto Mode: AI will analyze your query and choose the best search strategy
                </div>
            </div>
        </section>

        <!-- News-specific options section -->
        <section class="search-section" id="newsSearchSection" style="display: none;">
            <h2 class="results-title" style="margin-bottom: 20px;">üì∞ News Search Options</h2>
            
            <!-- News Category Selection -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
                <label style="color: var(--cyber-pink); font-weight: bold;">üì∞ Category:</label>
                <select id="newsCategory" style="padding: 8px; background: rgba(255, 20, 147, 0.1); border: 1px solid var(--cyber-pink); border-radius: 5px; color: white;">
                    <option value="">All News</option>
                    <option value="business">üíº Business</option>
                    <option value="technology">üíª Technology</option>
                    <option value="science">üî¨ Science</option>
                    <option value="health">üè• Health</option>
                    <option value="sports">‚öΩ Sports</option>
                    <option value="entertainment">üé¨ Entertainment</option>
                    <option value="general">üìã General</option>
                </select>
                
                <label style="color: var(--cyber-orange); margin-left: 15px; font-weight: bold;">üìÖ Time:</label>
                <select id="newsTimeframe" style="padding: 8px; background: rgba(255, 165, 0, 0.1); border: 1px solid var(--cyber-orange); border-radius: 5px; color: white;">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="">All Time</option>
                </select>
                
                <label style="color: var(--cyber-green); margin-left: 15px; font-weight: bold;">üåç Source:</label>
                <select id="newsSource" style="padding: 8px; background: rgba(0, 255, 0, 0.1); border: 1px solid var(--cyber-green); border-radius: 5px; color: white;">
                    <option value="">All Sources</option>
                    <option value="bbc-news">BBC News</option>
                    <option value="cnn">CNN</option>
                    <option value="reuters">Reuters</option>
                    <option value="associated-press">Associated Press</option>
                    <option value="techcrunch">TechCrunch</option>
                    <option value="the-verge">The Verge</option>
                </select>
            </div>
        </section>

        <section class="search-section" id="oldEventSearchSection" style="display: none;">
            <h2 class="results-title" id="eventSectionTitle" style="margin-bottom: 20px;">üé™ Advanced Event Search Options</h2>
            <!-- Tab Navigation -->
            <div style="display: flex; margin-bottom: 20px; border-bottom: 2px solid var(--cyber-blue);">
                <button id="eventsTab" class="tab-button" onclick="switchTab('events')" style="flex: 1; padding: 12px; background: var(--cyber-blue); color: black; border: none; font-weight: bold; cursor: pointer; border-radius: 5px 0 0 0;">
                    üé™ LIVE EVENTS
                </button>
                <button id="newsTab" class="tab-button" onclick="switchTab('news')" style="flex: 1; padding: 12px; background: rgba(0, 255, 255, 0.2); color: var(--cyber-blue); border: none; cursor: pointer; border-radius: 0 5px 0 0;">
                    üì∞ EVENT NEWS
                </button>
            </div>

            <!-- Sorting & Filter Options -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
                <label style="color: var(--cyber-orange); font-weight: bold;">üîÄ Sort by:</label>
                <select id="sortBy" style="padding: 8px; background: rgba(255, 165, 0, 0.1); border: 1px solid var(--cyber-orange); border-radius: 5px; color: white;">
                    <option value="relevance">Relevance Score</option>
                    <option value="date">Date (Soonest First)</option>
                    <option value="popularity">Popularity</option>
                    <option value="source">Source Quality</option>
                    <option value="price">Price (Free First)</option>
                </select>
                
                <label style="color: var(--cyber-pink); margin-left: 15px; font-weight: bold;">üéØ Focus:</label>
                <select id="eventFocus" style="padding: 8px; background: rgba(255, 20, 147, 0.1); border: 1px solid var(--cyber-pink); border-radius: 5px; color: white;">
                    <option value="all">All Events</option>
                    <option value="today">Today Only</option>
                    <option value="free">Free Events</option>
                    <option value="ticketed">Paid Events</option>
                    <option value="nearby">Close to Location</option>
                </select>
            </div>

            <div class="input-group">
                <input type="text" id="locationInput" class="cyber-input" placeholder="Enter location (city, state, zip)..." required />
                <select id="genreSelect" class="cyber-input" style="min-width: 200px;">
                    <option value="">All Genres</option>
                    <option value="tech">Technology & Tech Meetups</option>
                    <option value="business">Business & Networking</option>
                    <option value="arts">Arts & Culture</option>
                    <option value="music">Music & Concerts</option>
                    <option value="sports">Sports & Fitness</option>
                    <option value="food">Food & Drink</option>
                    <option value="gaming">Gaming & Esports</option>
                    <option value="education">Education & Learning</option>
                    <option value="health">Health & Wellness</option>
                    <option value="social">Social & Community</option>
                    <option value="outdoor">Outdoor & Adventure</option>
                    <option value="creative">Creative & DIY</option>
                    <option value="professional">Professional Development</option>
                    <option value="charity">Volunteer & Charity</option>
                </select>
            </div>
            <div class="input-group">
                <select id="eventTypeSelect" class="cyber-input" style="min-width: 200px;">
                    <option value="">All Event Types</option>
                    <option value="meetup">Meetups & Groups</option>
                    <option value="workshop">Workshops & Classes</option>
                    <option value="conference">Conferences & Seminars</option>
                    <option value="networking">Networking Events</option>
                    <option value="social">Social Gatherings</option>
                    <option value="online">Online Events</option>
                    <option value="festival">Festivals & Fairs</option>
                    <option value="concert">Concerts & Shows</option>
                    <option value="sports">Sports Events</option>
                    <option value="volunteer">Volunteer Opportunities</option>
                </select>
                <select id="timeframeSelect" class="cyber-input" style="min-width: 150px;">
                    <option value="immediate">Happening Now</option>
                    <option value="tonight">Tonight</option>
                    <option value="upcoming">This Week</option>
                    <option value="general">Any Time</option>
                </select>
                <input type="number" id="radiusInput" class="cyber-input" placeholder="Radius (miles)" value="25" min="1" max="100" style="max-width: 120px;" />
            </div>
            <div class="input-group">
                <button onclick="searchEvents()" class="cyber-button">üîç Find Events</button>
                <button onclick="loadNearbyEvents()" class="cyber-button" style="background: linear-gradient(45deg, var(--cyber-purple), var(--cyber-blue));">üìç Use Location</button>
                <button onclick="clearResults()" class="cyber-button" style="background: linear-gradient(45deg, var(--cyber-pink), var(--cyber-orange));">üóëÔ∏è Clear</button>
            </div>
        </section>

        <!-- Google Calendar Integration Section -->
        <section class="search-section" id="calendarSection" style="display: none;">
            <h2 class="results-title" style="margin-bottom: 20px;">üìÖ Google Calendar Integration</h2>
            
            <div class="input-group" style="justify-content: center; margin-bottom: 20px;">
                <button onclick="signInToGoogle()" id="signInButton" class="cyber-button" style="background: linear-gradient(45deg, var(--cyber-green), var(--cyber-blue));">
                    üîê Connect Google Calendar
                </button>
                <button onclick="signOutFromGoogle()" id="signOutButton" class="cyber-button" style="background: linear-gradient(45deg, var(--cyber-pink), var(--cyber-orange)); display: none;">
                    üö™ Disconnect Calendar
                </button>
            </div>

            <div id="calendarControls" style="display: none;">
                <div class="input-group">
                    <select id="calendarSelect" class="cyber-input" style="min-width: 200px;">
                        <option value="">Select a Calendar</option>
                    </select>
                    <input type="date" id="startDate" class="cyber-input" />
                    <input type="date" id="endDate" class="cyber-input" />
                    <button onclick="loadCalendarEvents()" class="cyber-button">üìÖ Load Events</button>
                </div>
                
                <div class="input-group">
                    <input type="text" id="eventTitle" class="cyber-input" placeholder="Event Title" />
                    <input type="datetime-local" id="eventStart" class="cyber-input" />
                    <input type="datetime-local" id="eventEnd" class="cyber-input" />
                    <button onclick="createCalendarEvent()" class="cyber-button" style="background: linear-gradient(45deg, var(--cyber-purple), var(--cyber-green));">
                        ‚ûï Create Event
                    </button>
                </div>
            </div>

            <!-- Calendar Widget -->
            <div id="calendarWidget" style="display: none; margin-top: 30px;">
                <div class="calendar-header">
                    <button onclick="changeMonth(-1)" class="cyber-button" style="padding: 10px;">‚Äπ</button>
                    <h3 id="currentMonth" style="color: var(--cyber-blue); margin: 0 20px; font-family: 'Orbitron', monospace;"></h3>
                    <button onclick="changeMonth(1)" class="cyber-button" style="padding: 10px;">‚Ä∫</button>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
                <div id="eventsForDay" class="events-for-day" style="display: none;"></div>
            </div>

            <div class="input-group" style="justify-content: center;">
                <small style="color: var(--cyber-blue); text-align: center;">
                    üìù View your Google Calendar events and create new ones directly from The Prospector
                </small>
            </div>
        </section>

        <section class="results-section" id="mainResultsSection">
            <!-- Events Tab Content -->
            <div id="eventsContent" class="tab-content">
                <h2 class="results-title">üé™ Live Events & Happenings</h2>
                <div id="eventsResults">
                    <p style="text-align: center; color: #666;">Enter location and preferences to discover live events...</p>
                </div>
            </div>
            
            <!-- News Tab Content -->
            <div id="newsContent" class="tab-content" style="display: none;">
                <h2 class="results-title">üì∞ Event News & Announcements</h2>
                <div id="newsResults">
                    <p style="text-align: center; color: #666;">Event news and announcements will appear here...</p>
                </div>
            </div>
            
        <!-- Combined Results (fallback) -->
        <div id="results" style="display: none;">
            <p style="text-align: center; color: #666;">Search results will appear here...</p>
        </div>
    </section>
</div>

<!-- Authentication Modals -->
<div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeAuthModal()">&times;</span>
        
        <!-- Login Form -->
        <div id="loginForm" style="display: none;">
            <h2 style="color: var(--cyber-blue); text-align: center; margin-bottom: 20px;">üîê Agent Login</h2>
            <form onsubmit="login(event)" style="display: flex; flex-direction: column; gap: 15px;">
                <input type="text" id="loginUsername" placeholder="Username or Email" class="cyber-input" required>
                <input type="password" id="loginPassword" placeholder="Password" class="cyber-input" required>
                <button type="submit" class="cyber-button">Access Network</button>
                <p style="text-align: center; color: #888; margin: 10px 0;">
                    New agent? <a href="#" onclick="switchToRegister()" style="color: var(--cyber-green);">Register here</a>
                </p>
            </form>
        </div>
        
        <!-- Register Form -->
        <div id="registerForm" style="display: none;">
            <h2 style="color: var(--cyber-green); text-align: center; margin-bottom: 20px;">üë§ Agent Registration</h2>
            <form onsubmit="register(event)" style="display: flex; flex-direction: column; gap: 15px;">
                <input type="text" id="regUsername" placeholder="Username" class="cyber-input" required>
                <input type="email" id="regEmail" placeholder="Email Address" class="cyber-input" required>
                <input type="password" id="regPassword" placeholder="Password (min 6 chars)" class="cyber-input" required minlength="6">
                <input type="text" id="regFirstName" placeholder="First Name (optional)" class="cyber-input">
                <input type="text" id="regLastName" placeholder="Last Name (optional)" class="cyber-input">
                <button type="submit" class="cyber-button">Join Network</button>
                <p style="text-align: center; color: #888; margin: 10px 0;">
                    Already an agent? <a href="#" onclick="switchToLogin()" style="color: var(--cyber-blue);">Login here</a>
                </p>
            </form>
        </div>
        
        <!-- Profile Form -->
        <div id="profileForm" style="display: none;">
            <h2 style="color: var(--cyber-orange); text-align: center; margin-bottom: 20px;">‚öôÔ∏è Agent Profile</h2>
            <form onsubmit="updateProfile(event)" style="display: flex; flex-direction: column; gap: 15px;">
                <input type="text" id="profileFirstName" placeholder="First Name" class="cyber-input">
                <input type="text" id="profileLastName" placeholder="Last Name" class="cyber-input">
                <input type="text" id="profileDefaultLocation" placeholder="Default Location" class="cyber-input">
                <label style="color: var(--cyber-blue); margin-top: 10px;">Email Notifications:</label>
                <label style="display: flex; align-items: center; gap: 10px; color: #ccc;">
                    <input type="checkbox" id="profileEmailNotifications" style="scale: 1.2;">
                    Receive email updates
                </label>
                <button type="submit" class="cyber-button">Update Profile</button>
                <button type="button" onclick="showChangePassword()" class="cyber-button" style="background: linear-gradient(45deg, var(--cyber-orange), var(--cyber-pink)); margin-top: 10px;">
                    Change Password
                </button>
            </form>
        </div>
        
        <!-- Change Password Form -->
        <div id="changePasswordForm" style="display: none;">
            <h2 style="color: var(--cyber-pink); text-align: center; margin-bottom: 20px;">üîí Change Password</h2>
            <form onsubmit="changePassword(event)" style="display: flex; flex-direction: column; gap: 15px;">
                <input type="password" id="currentPassword" placeholder="Current Password" class="cyber-input" required>
                <input type="password" id="newPassword" placeholder="New Password (min 6 chars)" class="cyber-input" required minlength="6">
                <input type="password" id="confirmPassword" placeholder="Confirm New Password" class="cyber-input" required minlength="6">
                <button type="submit" class="cyber-button">Update Password</button>
                <button type="button" onclick="showProfileForm()" class="cyber-button" style="background: #666; margin-top: 10px;">
                    Back to Profile
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Search Preview Modal -->
<div id="previewModal" class="preview-modal">
    <div class="preview-content">
        <div class="preview-header">
            <h2 style="color: var(--cyber-blue); margin: 0;">üîç Search Preview</h2>
            <div class="preview-close" onclick="closePreviewModal()">√ó</div>
        </div>
        <div id="previewDetails" style="margin-bottom: 20px;">
            <!-- Search details will be loaded here -->
        </div>
        <div class="preview-results" id="previewResults">
            <!-- Search results will be loaded here -->
        </div>
    </div>
</div>

    <script>
        // GitHub, Reddit, and Google Calendar API Configuration
        const API_CONFIG = {
            github: {
                token: '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',
                baseUrl: 'https://api.github.com'
            },
            reddit: {
                clientId: '6WvFTgrgGLXjqOyXGRSlZQ',
                clientSecret: 'jb3MA8zQxBllZIVPV6PtqkFrut-m-g',
                userAgent: 'wild west prospector scraper v1.0',
                redirectUri: 'http://localhost:8080',
                baseUrl: 'https://www.reddit.com/api/v1'
            },
            googleCalendar: {
                apiKey: 'AIzaSyDet8FIQM8OnoPdhhVoR6_4NfuiKynBHoE',
                clientId: '1012494277929-nkdc974uqvstuoqmd9b41cuotn1cb8uq.apps.googleusercontent.com',
                discoveryDoc: 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
                scopes: 'https://www.googleapis.com/auth/calendar'
            }
        };

        // Enhanced GitHub API with robust error handling and retry logic
        async function searchGitHub(query, retries = 3) {
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const response = await fetch(`${API_CONFIG.github.baseUrl}/search/repositories?q=${encodeURIComponent(query)}&sort=stars&per_page=20`, {
                        headers: {
                            'Authorization': `token ${API_CONFIG.github.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'User-Agent': 'The-Prospector-App',
                            'X-GitHub-Api-Version': '2022-11-28'
                        }
                    });
                    
                    if (response.status === 403) {
                        // Rate limit hit, wait and retry
                        const resetTime = response.headers.get('X-RateLimit-Reset');
                        if (resetTime) {
                            const waitTime = (parseInt(resetTime) * 1000) - Date.now();
                            if (waitTime > 0 && waitTime < 60000) { // Wait max 1 minute
                                console.log(`Rate limited, waiting ${waitTime}ms`);
                                await new Promise(resolve => setTimeout(resolve, waitTime));
                                continue;
                            }
                        }
                    }
                    
                    if (!response.ok) {
                        throw new Error(`GitHub API Error: ${response.status} - ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('GitHub API success:', data.total_count, 'repositories found');
                    return data;
                    
                } catch (error) {
                    console.error(`GitHub attempt ${attempt + 1} failed:`, error);
                    if (attempt === retries - 1) {
                        throw error;
                    }
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                }
            }
        }

        // ========== GOOGLE CALENDAR API INTEGRATION ==========
        
        let isGoogleApiLoaded = false;
        let isGoogleSignedIn = false;
        let isInitializing = false;
        let googleCalendars = [];
        let accessToken = null;

        // Initialize Google APIs with new Google Identity Services
        async function initializeGoogleApis() {
            if (isGoogleApiLoaded || isInitializing) return;
            
            isInitializing = true;
            
            try {
                // Validate API credentials
                if (!API_CONFIG.googleCalendar.apiKey || API_CONFIG.googleCalendar.apiKey === 'YOUR_GOOGLE_CALENDAR_API_KEY') {
                    throw new Error('Google Calendar API key not configured. Please add your API key to the configuration.');
                }
                
                if (!API_CONFIG.googleCalendar.clientId || API_CONFIG.googleCalendar.clientId === 'YOUR_GOOGLE_CLIENT_ID') {
                    throw new Error('Google Calendar Client ID not configured. Please add your Client ID to the configuration.');
                }
                
                // Check if gapi is available
                if (typeof gapi === 'undefined') {
                    throw new Error('Google API script not loaded. Please check your internet connection.');
                }
                
                console.log('Testing API key validity...');
                // Test the API key with a simple request first
                try {
                    const testResponse = await fetch(`https://www.googleapis.com/calendar/v3/users/me/calendarList?key=${API_CONFIG.googleCalendar.apiKey}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    if (testResponse.status === 403) {
                        const errorData = await testResponse.json();
                        console.error('API Key Error:', errorData);
                        if (errorData.error?.message?.includes('API key not valid')) {
                            throw new Error('API key is invalid. Please check your Google Cloud Console API key configuration.');
                        } else if (errorData.error?.message?.includes('restricted')) {
                            throw new Error('API key restrictions are preventing access. Please check your API key restrictions in Google Cloud Console.');
                        } else {
                            throw new Error('API key access denied. Please ensure Calendar API is enabled and key is properly configured.');
                        }
                    } else if (testResponse.status === 401) {
                        console.log('API key test: Authentication required for calendar access (this is expected)');
                    }
                } catch (fetchError) {
                    if (fetchError.message.includes('API key')) {
                        throw fetchError; // Re-throw our custom API key errors
                    }
                    console.log('API key test: Network or CORS issue (this may be normal)');
                }
                
                console.log('Loading Google API client...');
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout loading Google API client'));
                    }, 10000);
                    
                    gapi.load('client', {
                        callback: () => {
                            clearTimeout(timeout);
                            resolve();
                        },
                        onerror: () => {
                            clearTimeout(timeout);
                            reject(new Error('Failed to load Google API client'));
                        }
                    });
                });

                console.log('Initializing Google client...');
                await gapi.client.init({
                    apiKey: API_CONFIG.googleCalendar.apiKey,
                    discoveryDocs: [API_CONFIG.googleCalendar.discoveryDoc]
                });

                // Initialize Google Identity Services
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.initialize({
                        client_id: API_CONFIG.googleCalendar.clientId,
                        callback: handleGoogleSignIn
                    });
                } else {
                    console.warn('Google Identity Services not available - sign-in may not work');
                }

                isGoogleApiLoaded = true;
                isInitializing = false;
                console.log('Google Calendar API initialized successfully');
            } catch (error) {
                isInitializing = false;
                console.error('Failed to initialize Google Calendar API:', error);
                
                // Show specific error message based on the error
                let errorMsg = 'Failed to initialize Google Calendar API. ';
                const errorMessage = error?.message || error?.error || error || 'Unknown error';
                
                if (typeof errorMessage === 'string') {
                    if (errorMessage.includes('API key not configured')) {
                        errorMsg = errorMessage;
                    } else if (errorMessage.includes('Client ID not configured')) {
                        errorMsg = errorMessage;
                    } else if (errorMessage.includes('API key is invalid')) {
                        errorMsg = errorMessage;
                    } else if (errorMessage.includes('script not loaded')) {
                        errorMsg += 'Google API scripts failed to load. Please check your internet connection.';
                    } else {
                        errorMsg += `Error: ${errorMessage}`;
                    }
                } else {
                    errorMsg += 'Please check your API credentials in Google Cloud Console.';
                }
                
                throw new Error(errorMsg);
            }
        }

        // Sign in to Google using OAuth2 for Calendar access
        async function signInToGoogle() {
            try {
                if (!isGoogleApiLoaded) {
                    console.log('Initializing Google APIs...');
                    await initializeGoogleApis();
                }

                console.log('Starting Google OAuth sign-in...');
                
                // Check if Google Identity Services is available
                if (typeof google === 'undefined' || !google.accounts) {
                    throw new Error('Google Identity Services not loaded');
                }
                
                // Use Google OAuth2 for Calendar scope access
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: API_CONFIG.googleCalendar.clientId,
                    scope: API_CONFIG.googleCalendar.scopes,
                    callback: (response) => {
                        console.log('OAuth response:', response);
                        
                        if (response.error) {
                            console.error('OAuth error:', response.error);
                            let errorMsg = 'OAuth authentication failed. ';
                            
                            if (response.error === 'access_denied') {
                                errorMsg += 'User denied access or you are not added as a test user.';
                            } else if (response.error === 'popup_blocked_by_browser') {
                                errorMsg += 'Popup was blocked. Please allow popups for this site.';
                            } else {
                                errorMsg += `Error: ${response.error}`;
                            }
                            
                            const resultsDiv = document.getElementById('eventsResults');
                            resultsDiv.innerHTML = `
                                <div class="result-item" style="border-color: var(--cyber-pink);">
                                    <div class="result-title">‚ùå OAuth Authentication Failed</div>
                                    <div style="margin: 15px 0; color: var(--cyber-pink);">
                                        ${errorMsg}
                                    </div>
                                    <div style="color: #666; font-size: 0.9em;">
                                        Check that you are added as a test user in Google Cloud Console OAuth consent screen.
                                    </div>
                                </div>
                            `;
                            return;
                        }
                        
                        console.log('OAuth sign-in successful');
                        accessToken = response.access_token;
                        gapi.client.setApiKey(API_CONFIG.googleCalendar.apiKey);
                        gapi.client.setToken({ access_token: accessToken });
                        
                        isGoogleSignedIn = true;
                        updateCalendarUI();
                        
                        // Show success message
                        const resultsDiv = document.getElementById('eventsResults');
                        resultsDiv.innerHTML = `
                            <div class="result-item" style="border-color: var(--cyber-green);">
                                <div class="result-title">‚úÖ Google Calendar Connected Successfully!</div>
                                <div style="margin: 15px 0; color: var(--cyber-green);">
                                    You can now view and manage your Google Calendar events.
                                </div>
                            </div>
                        `;
                    }
                });
                
                client.requestAccessToken();
                
            } catch (error) {
                console.error('Google Calendar sign-in failed:', error);
                
                let errorMessage = 'Failed to sign in to Google Calendar. ';
                const errorMsg = error?.message || error?.error || error || 'Unknown error';
                
                if (typeof errorMsg === 'string') {
                    if (errorMsg.includes('popup_blocked')) {
                        errorMessage += 'Please allow popups for this site and try again.';
                    } else if (errorMsg.includes('access_denied')) {
                        errorMessage += 'Access denied. Please check that you are added as a test user in Google Cloud Console.';
                    } else if (errorMsg.includes('not loaded')) {
                        errorMessage += 'Google services failed to load. Please refresh the page and try again.';
                    } else {
                        errorMessage += `Error: ${errorMsg}`;
                    }
                } else {
                    errorMessage += 'Please check your API credentials and try again.';
                }
                
                const resultsDiv = document.getElementById('eventsResults');
                resultsDiv.innerHTML = `
                    <div class="result-item" style="border-color: var(--cyber-pink);">
                        <div class="result-title">‚ùå Calendar Connection Failed</div>
                        <div style="margin: 15px 0; color: var(--cyber-pink);">
                            ${errorMessage}
                        </div>
                        <div style="color: #666; font-size: 0.9em;">
                            Check console for more details.
                        </div>
                    </div>
                `;
            }
        }

        // Sign out from Google
        async function signOutFromGoogle() {
            try {
                // Revoke the access token
                if (accessToken) {
                    google.accounts.oauth2.revoke(accessToken);
                    accessToken = null;
                }
                
                // Clear the API token
                gapi.client.setToken(null);
                
                isGoogleSignedIn = false;
                await updateCalendarUI();
                
                const resultsDiv = document.getElementById('eventsResults');
                resultsDiv.innerHTML = `
                    <div class="result-item" style="border-color: var(--cyber-orange);">
                        <div class="result-title">üö™ Disconnected from Google Calendar</div>
                        <div style="margin: 15px 0; color: var(--cyber-orange);">
                            You have been signed out successfully.
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Google sign-out failed:', error);
                // Force sign out anyway
                isGoogleSignedIn = false;
                accessToken = null;
                await updateCalendarUI();
            }
        }

        // Update Calendar UI based on sign-in status
        async function updateCalendarUI() {
            const signInButton = document.getElementById('signInButton');
            const signOutButton = document.getElementById('signOutButton');
            const calendarControls = document.getElementById('calendarControls');
            const calendarWidget = document.getElementById('calendarWidget');
            
            if (isGoogleSignedIn) {
                signInButton.style.display = 'none';
                signOutButton.style.display = 'inline-block';
                calendarControls.style.display = 'block';
                
                // Load available calendars
                await loadGoogleCalendars();
                
                // Initialize and show calendar widget
                initializeCalendarWidget();
                
            } else {
                signInButton.style.display = 'inline-block';
                signOutButton.style.display = 'none';
                calendarControls.style.display = 'none';
                calendarWidget.style.display = 'none';
            }
        }

        // Load Google Calendars
        async function loadGoogleCalendars() {
            try {
                const response = await gapi.client.calendar.calendarList.list();
                googleCalendars = response.result.items || [];
                
                const calendarSelect = document.getElementById('calendarSelect');
                calendarSelect.innerHTML = '<option value="">Select a Calendar</option>';
                
                googleCalendars.forEach(calendar => {
                    const option = document.createElement('option');
                    option.value = calendar.id;
                    option.textContent = calendar.summary;
                    if (calendar.primary) {
                        option.textContent += ' (Primary)';
                        option.selected = true;
                    }
                    calendarSelect.appendChild(option);
                });
                
                // Add event listener for calendar selection change
                calendarSelect.addEventListener('change', function() {
                    if (this.value) {
                        loadCalendarEventsForWidget();
                    }
                });
                
                // Auto-load events for primary calendar
                if (googleCalendars.some(cal => cal.primary)) {
                    loadCalendarEventsForWidget();
                }
                
                // Set default date range (next 30 days)
                const today = new Date();
                const nextMonth = new Date();
                nextMonth.setDate(today.getDate() + 30);
                
                document.getElementById('startDate').value = today.toISOString().split('T')[0];
                document.getElementById('endDate').value = nextMonth.toISOString().split('T')[0];
                
            } catch (error) {
                console.error('Failed to load calendars:', error);
                alert('Failed to load your calendars. Please try again.');
            }
        }

        // Load Calendar Events
        async function loadCalendarEvents() {
            try {
                const calendarId = document.getElementById('calendarSelect').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!calendarId) {
                    alert('Please select a calendar');
                    return;
                }
                
                if (!startDate || !endDate) {
                    alert('Please select start and end dates');
                    return;
                }
                
                const resultsDiv = document.getElementById('eventsResults');
                resultsDiv.innerHTML = '<div class="loading">üìÖ Loading calendar events...</div>';
                
                const timeMin = new Date(startDate).toISOString();
                const timeMax = new Date(endDate + 'T23:59:59').toISOString();
                
                const response = await gapi.client.calendar.events.list({
                    calendarId: calendarId,
                    timeMin: timeMin,
                    timeMax: timeMax,
                    showDeleted: false,
                    singleEvents: true,
                    orderBy: 'startTime'
                });
                
                const events = response.result.items || [];
                displayCalendarEvents(events, calendarId);
                
            } catch (error) {
                console.error('Failed to load calendar events:', error);
                const resultsDiv = document.getElementById('eventsResults');
                resultsDiv.innerHTML = `
                    <div class="result-item" style="border-color: var(--cyber-pink);">
                        <div class="result-title">‚ùå Failed to Load Calendar Events</div>
                        <div style="margin: 15px 0; color: var(--cyber-pink);">
                            Error: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Display Calendar Events
        function displayCalendarEvents(events, calendarId) {
            const resultsDiv = document.getElementById('eventsResults');
            const calendarName = googleCalendars.find(cal => cal.id === calendarId)?.summary || 'Calendar';
            
            if (events.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="result-item" style="border-color: var(--cyber-blue);">
                        <div class="result-title">üìÖ ${calendarName}</div>
                        <div style="margin: 15px 0; color: var(--cyber-blue);">
                            No events found in the selected date range.
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="result-item" style="border-color: var(--cyber-green);">
                    <div class="result-title">üìÖ ${calendarName} Events (${events.length})</div>
            `;
            
            events.forEach(event => {
                const startTime = event.start.dateTime || event.start.date;
                const endTime = event.end.dateTime || event.end.date;
                const isAllDay = !event.start.dateTime;
                
                const startDate = new Date(startTime);
                const endDate = new Date(endTime);
                
                const timeDisplay = isAllDay 
                    ? `All day - ${startDate.toLocaleDateString()}`
                    : `${startDate.toLocaleString()} - ${endDate.toLocaleString()}`;
                
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: rgba(0, 255, 65, 0.1); border-radius: 8px; border-left: 4px solid var(--cyber-green);">
                        <div style="font-weight: bold; color: var(--cyber-green); margin-bottom: 5px;">
                            ${event.summary || 'No Title'}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--cyber-blue); margin-bottom: 5px;">
                            üïí ${timeDisplay}
                        </div>
                        ${event.location ? `
                            <div style="font-size: 0.9rem; color: var(--cyber-purple); margin-bottom: 5px;">
                                üìç ${event.location}
                            </div>
                        ` : ''}
                        ${event.description ? `
                            <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 5px;">
                                ${event.description.length > 200 ? event.description.substring(0, 200) + '...' : event.description}
                            </div>
                        ` : ''}
                        ${event.htmlLink ? `
                            <div style="margin-top: 8px;">
                                <a href="${event.htmlLink}" target="_blank" style="color: var(--cyber-blue); text-decoration: none;">
                                    üîó Open in Google Calendar
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // Create Calendar Event
        async function createCalendarEvent() {
            try {
                const calendarId = document.getElementById('calendarSelect').value;
                const title = document.getElementById('eventTitle').value.trim();
                const startDateTime = document.getElementById('eventStart').value;
                const endDateTime = document.getElementById('eventEnd').value;
                
                if (!calendarId) {
                    alert('Please select a calendar');
                    return;
                }
                
                if (!title || !startDateTime || !endDateTime) {
                    alert('Please fill in all event details');
                    return;
                }
                
                const event = {
                    summary: title,
                    start: {
                        dateTime: new Date(startDateTime).toISOString(),
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    end: {
                        dateTime: new Date(endDateTime).toISOString(),
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    }
                };
                
                const response = await gapi.client.calendar.events.insert({
                    calendarId: calendarId,
                    resource: event
                });
                
                // Clear form
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventStart').value = '';
                document.getElementById('eventEnd').value = '';
                
                // Show success message
                const resultsDiv = document.getElementById('eventsResults');
                resultsDiv.innerHTML = `
                    <div class="result-item" style="border-color: var(--cyber-green);">
                        <div class="result-title">‚úÖ Event Created Successfully!</div>
                        <div style="margin: 15px 0; color: var(--cyber-green);">
                            "${title}" has been added to your calendar.
                        </div>
                        <div style="margin-top: 10px;">
                            <a href="${response.result.htmlLink}" target="_blank" style="color: var(--cyber-blue);">
                                üîó View in Google Calendar
                            </a>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Failed to create calendar event:', error);
                alert('Failed to create calendar event. Please try again.');
            }
        }

        // ========== CALENDAR WIDGET FUNCTIONS ==========
        
        let currentCalendarDate = new Date();
        let calendarEvents = [];
        
        // Initialize Calendar Widget
        function initializeCalendarWidget() {
            generateCalendar();
            // Show the calendar widget when signed in
            document.getElementById('calendarWidget').style.display = 'block';
        }
        
        // Generate Calendar Grid
        function generateCalendar() {
            const calendar = document.getElementById('calendarGrid');
            const monthHeader = document.getElementById('currentMonth');
            
            // Clear calendar
            calendar.innerHTML = '';
            
            // Set month header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            monthHeader.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // Get first day of the month and number of days
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                calendar.appendChild(emptyDay);
            }
            
            // Add days of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const currentDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
                
                // Check if it's today
                if (currentDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Check if there are events on this day
                const dayEvents = getEventsForDate(currentDate);
                if (dayEvents.length > 0) {
                    dayElement.classList.add('has-events');
                }
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);
                
                // Add event banners (max 3, show titles)
                dayEvents.slice(0, 3).forEach((event, index) => {
                    const eventBanner = document.createElement('div');
                    eventBanner.className = 'calendar-event-banner';
                    
                    // Get event title and truncate if too long
                    let title = event.summary || 'Event';
                    if (title.length > 12) {
                        title = title.substring(0, 10) + '..';
                    }
                    
                    // Add time for non-all-day events
                    if (event.start.dateTime) {
                        const startTime = new Date(event.start.dateTime);
                        const timeStr = startTime.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
                        eventBanner.textContent = `${timeStr} ${title}`;
                    } else {
                        eventBanner.textContent = title;
                    }
                    
                    // Add tooltip
                    eventBanner.title = event.summary || 'Event';
                    
                    dayElement.appendChild(eventBanner);
                });
                
                // If more than 3 events, show "+X more" banner
                if (dayEvents.length > 3) {
                    const moreBanner = document.createElement('div');
                    moreBanner.className = 'calendar-event-banner';
                    moreBanner.textContent = `+${dayEvents.length - 3} more`;
                    moreBanner.style.background = 'linear-gradient(45deg, var(--cyber-pink), var(--cyber-purple))';
                    moreBanner.style.fontSize = '0.6rem';
                    moreBanner.title = `${dayEvents.length - 3} additional events`;
                    dayElement.appendChild(moreBanner);
                }
                
                // Add click handler
                dayElement.addEventListener('click', () => showEventsForDay(currentDate, dayEvents));
                
                calendar.appendChild(dayElement);
            }
        }
        
        // Change Calendar Month
        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            generateCalendar();
            // Reload events for the new month
            loadCalendarEventsForWidget();
        }
        
        // Get Events for a Specific Date
        function getEventsForDate(date) {
            return calendarEvents.filter(event => {
                const eventDate = new Date(event.start.dateTime || event.start.date);
                return eventDate.toDateString() === date.toDateString();
            });
        }
        
        // Show Events for Selected Day
        function showEventsForDay(date, events) {
            const eventsContainer = document.getElementById('eventsForDay');
            const dateStr = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            if (events.length === 0) {
                eventsContainer.innerHTML = `
                    <h4>üìÖ ${dateStr}</h4>
                    <p style="color: #666; font-style: italic;">No events scheduled for this day</p>
                `;
            } else {
                let html = `<h4>üìÖ ${dateStr} (${events.length} event${events.length > 1 ? 's' : ''})</h4>`;
                
                events.forEach(event => {
                    const startTime = event.start.dateTime || event.start.date;
                    const endTime = event.end.dateTime || event.end.date;
                    const isAllDay = !event.start.dateTime;
                    
                    const startDate = new Date(startTime);
                    const endDate = new Date(endTime);
                    
                    const timeDisplay = isAllDay 
                        ? 'All day'
                        : `${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    
                    html += `
                        <div class="calendar-event-item">
                            <div class="calendar-event-title">${event.summary || 'No Title'}</div>
                            <div class="calendar-event-time">üïí ${timeDisplay}</div>
                            ${event.location ? `<div class="calendar-event-description">üìç ${event.location}</div>` : ''}
                            ${event.description ? `<div class="calendar-event-description">${event.description.length > 100 ? event.description.substring(0, 100) + '...' : event.description}</div>` : ''}
                            ${event.htmlLink ? `<div style="margin-top: 8px;"><a href="${event.htmlLink}" target="_blank" style="color: var(--cyber-blue);">üîó Open in Google Calendar</a></div>` : ''}
                        </div>
                    `;
                });
                
                eventsContainer.innerHTML = html;
            }
            
            eventsContainer.style.display = 'block';
        }
        
        // Load Calendar Events for Widget
        async function loadCalendarEventsForWidget() {
            try {
                const calendarId = document.getElementById('calendarSelect').value;
                if (!calendarId) return;
                
                // Get events for the current month
                const startOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
                const endOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
                
                const timeMin = startOfMonth.toISOString();
                const timeMax = endOfMonth.toISOString();
                
                const response = await gapi.client.calendar.events.list({
                    calendarId: calendarId,
                    timeMin: timeMin,
                    timeMax: timeMax,
                    showDeleted: false,
                    singleEvents: true,
                    orderBy: 'startTime'
                });
                
                calendarEvents = response.result.items || [];
                generateCalendar(); // Refresh calendar with events
                
            } catch (error) {
                console.error('Failed to load calendar events for widget:', error);
                calendarEvents = [];
            }
        }

        // Enhanced Reddit search with working CORS proxy
        async function searchReddit(query, subreddit = '', retries = 3) {
            // Input validation
            if (!query || typeof query !== 'string') {
                console.error('Invalid query provided to searchReddit:', query);
                return null;
            }
            
            const cleanQuery = query.trim();
            if (!cleanQuery) {
                console.error('Empty query after cleaning');
                return null;
            }

            console.log(`üîç Searching Reddit for: "${cleanQuery}"`);

            try {
                // Use pushshift.io API as it's more reliable for searches
                const pushShiftUrl = `https://api.pushshift.io/reddit/search/submission/?q=${encodeURIComponent(cleanQuery)}&size=25&sort=desc`;
                console.log('Trying Pushshift API:', pushShiftUrl);
                
                const response = await fetch(pushShiftUrl);
                
                if (response.ok) {
                    const pushShiftData = await response.json();
                    
                    if (pushShiftData.data && pushShiftData.data.length > 0) {
                        // Convert pushshift format to Reddit format
                        const redditFormatData = {
                            data: {
                                children: pushShiftData.data.map(post => ({
                                    data: {
                                        title: post.title || 'No title',
                                        url: post.url || `https://reddit.com/r/${post.subreddit}/comments/${post.id}/`,
                                        permalink: `/r/${post.subreddit}/comments/${post.id}/`,
                                        subreddit: post.subreddit || 'unknown',
                                        score: post.score || 0,
                                        num_comments: post.num_comments || 0,
                                        selftext: post.selftext || '',
                                        author: post.author || 'unknown',
                                        created_utc: post.created_utc || 0
                                    }
                                }))
                            }
                        };
                        
                        console.log(`‚úÖ Pushshift API success: ${redditFormatData.data.children.length} posts found`);
                        return redditFormatData;
                    }
                }
                
                console.log('Pushshift API failed, trying Reddit JSON API with CORS proxy...');
                
                // Fallback to Reddit JSON API with CORS proxy
                let redditUrl;
                if (subreddit) {
                    redditUrl = `https://www.reddit.com/r/${encodeURIComponent(subreddit)}/search.json?q=${encodeURIComponent(cleanQuery)}&limit=25&sort=relevance&t=all`;
                } else {
                    redditUrl = `https://www.reddit.com/search.json?q=${encodeURIComponent(cleanQuery)}&limit=25&sort=hot&t=all`;
                }
                
                // Try with a reliable CORS proxy
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(redditUrl)}`;
                console.log('Trying CORS proxy:', proxyUrl);
                
                const proxyResponse = await fetch(proxyUrl);
                
                if (proxyResponse.ok) {
                    const data = await proxyResponse.json();
                    
                    if (data && data.data && Array.isArray(data.data.children)) {
                        console.log(`‚úÖ Reddit JSON API success: ${data.data.children.length} posts found`);
                        return data;
                    }
                }
                
                console.log('CORS proxy failed, trying alternative proxy...');
                
                // Try alternative proxy
                const altProxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(redditUrl)}`;
                const altResponse = await fetch(altProxyUrl);
                
                if (altResponse.ok) {
                    const altData = await altResponse.json();
                    
                    if (altData.contents) {
                        try {
                            const parsedData = JSON.parse(altData.contents);
                            if (parsedData && parsedData.data && Array.isArray(parsedData.data.children)) {
                                console.log(`‚úÖ Alternative proxy success: ${parsedData.data.children.length} posts found`);
                                return parsedData;
                            }
                        } catch (parseError) {
                            console.error('Failed to parse alternative proxy response:', parseError);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Reddit search error:', error);
            }
            
            // Final fallback: return mock data structure
            console.log('‚ö†Ô∏è All Reddit strategies failed, returning fallback data');
            return {
                data: {
                    children: [{
                        data: {
                            title: `Reddit Search: "${cleanQuery}"`,
                            url: `https://www.reddit.com/search?q=${encodeURIComponent(cleanQuery)}`,
                            permalink: `/search?q=${encodeURIComponent(cleanQuery)}`,
                            subreddit: 'search',
                            score: 0,
                            num_comments: 0,
                            selftext: 'Reddit search temporarily unavailable. Click to search manually on Reddit.',
                            author: 'system',
                            created_utc: Date.now() / 1000
                        }
                    }]
                }
            };
        }

        // Enhanced general search function with GitHub and Reddit integration
        async function generalSearch() {
            const query = document.getElementById('universalSearchQuery').value.trim() || document.getElementById('queryInput').value.trim();
            const url = document.getElementById('urlInput').value.trim();
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const resultsDiv = document.getElementById('eventsResults');
            resultsDiv.innerHTML = '<div class="loading">Searching across multiple platforms...</div>';

            try {
                const allResults = [];

                // Search GitHub
                try {
                    resultsDiv.innerHTML = '<div class="loading">Searching GitHub repositories...</div>';
                    const githubData = await searchGitHub(query);
                    if (githubData && githubData.items) {
                        const githubResults = githubData.items.slice(0, 10).map(repo => ({
                            title: `${repo.name} (GitHub)`,
                            link: repo.html_url,
                            description: repo.description || 'No description available',
                            source: 'GitHub',
                            stars: repo.stargazers_count,
                            language: repo.language,
                            updated: repo.updated_at
                        }));
                        allResults.push(...githubResults);
                    }
                } catch (error) {
                    console.error('GitHub search error:', error);
                }

                // Search Reddit
                try {
                    resultsDiv.innerHTML = '<div class="loading">Searching Reddit posts...</div>';
                    const redditData = await searchReddit(query);
                    console.log('Reddit data received:', redditData);
                    
                    if (redditData && redditData.data && redditData.data.children && redditData.data.children.length > 0) {
                        const redditResults = redditData.data.children
                            .filter(post => post.data && post.data.title)
                            .slice(0, 10)
                            .map(post => {
                                const postData = post.data;
                                return {
                                    title: `${postData.title} (Reddit)`,
                                    link: postData.url.startsWith('http') ? postData.url : `https://reddit.com${postData.permalink}`,
                                    description: postData.selftext ? 
                                        (postData.selftext.length > 200 ? postData.selftext.substring(0, 200) + '...' : postData.selftext) :
                                        `Posted in r/${postData.subreddit} ‚Ä¢ Score: ${postData.score} ‚Ä¢ ${postData.num_comments} comments`,
                                    source: 'Reddit',
                                    subreddit: postData.subreddit,
                                    score: postData.score,
                                    comments: postData.num_comments
                                };
                            });
                        allResults.push(...redditResults);
                        console.log('Reddit results processed:', redditResults.length);
                    } else {
                        console.log('No Reddit results found or invalid data structure');
                    }
                } catch (error) {
                    console.error('Reddit search error:', error);
                    allResults.push({
                        title: 'Reddit Search (Limited)',
                        link: `https://www.reddit.com/search?q=${encodeURIComponent(query)}`,
                        description: 'Reddit search encountered issues. Click to search manually on Reddit.',
                        source: 'Reddit'
                    });
                }

                // Search local API if available
                try {
                    const requestBody = { query };
                    if (url) {
                        requestBody.url = url;
                    }

                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.events && data.events.length > 0) {
                            allResults.push(...data.events.map(event => ({
                                ...event,
                                source: 'Events'
                            })));
                        }
                        if (data.news && data.news.length > 0) {
                            allResults.push(...data.news.map(news => ({
                                ...news,
                                source: 'News'
                            })));
                        }
                    }
                } catch (error) {
                    console.error('Local search error:', error);
                }

                // Display all results
                displaySocialResults(allResults);
                
            } catch (error) {
                console.error('General search error:', error);
                resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">Search operation failed. Check network connection.</div>';
            }
        }

        // GitHub-only search function
        async function searchGitHubOnly() {
            const query = document.getElementById('universalSearchQuery').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const resultsDiv = document.getElementById('eventsResults');
            resultsDiv.innerHTML = '<div class="loading">Searching GitHub repositories...</div>';

            try {
                const githubData = await searchGitHub(query);
                if (githubData && githubData.items) {
                    const githubResults = githubData.items.map(repo => ({
                        title: repo.name,
                        link: repo.html_url,
                        description: repo.description || 'No description available',
                        source: 'GitHub',
                        stars: repo.stargazers_count,
                        language: repo.language,
                        updated: repo.updated_at,
                        forks: repo.forks_count,
                        issues: repo.open_issues_count
                    }));
                    displaySocialResults(githubResults);
                } else {
                    resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">No GitHub repositories found.</div>';
                }
            } catch (error) {
                console.error('GitHub search error:', error);
                resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">GitHub search failed.</div>';
            }
        }

        // Reddit-only search function
        async function searchRedditOnly() {
            const query = document.getElementById('universalSearchQuery').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const resultsDiv = document.getElementById('eventsResults');
            resultsDiv.innerHTML = '<div class="loading">Searching Reddit posts...</div>';

            try {
                const redditData = await searchReddit(query);
                if (redditData && redditData.data && redditData.data.children) {
                    const redditResults = redditData.data.children
                        .filter(post => post.data && post.data.title)
                        .map(post => {
                            const postData = post.data;
                            return {
                                title: postData.title,
                                link: postData.url.startsWith('http') ? postData.url : `https://reddit.com${postData.permalink}`,
                                description: postData.selftext || `Posted in r/${postData.subreddit}`,
                                source: 'Reddit',
                                subreddit: postData.subreddit,
                                score: postData.score,
                                comments: postData.num_comments,
                                author: postData.author
                            };
                        });
                    displaySocialResults(redditResults);
                } else {
                    resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">No Reddit posts found.</div>';
                }
            } catch (error) {
                console.error('Reddit search error:', error);
                resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">Reddit search failed.</div>';
            }
        }

        // News-only search function
        async function searchNewsOnly(query) {
            if (!query) {
                query = document.getElementById('universalSearchQuery').value.trim();
                if (!query) {
                    alert('Please enter a search query');
                    return;
                }
            }

            // Get filter options
            const category = document.getElementById('newsCategory')?.value || '';
            const timeframe = document.getElementById('newsTimeframe')?.value || '';
            const source = document.getElementById('newsSource')?.value || '';

            const resultsDiv = document.getElementById('eventsResults');
            resultsDiv.innerHTML = '<div class="loading">üì∞ Searching latest news...</div>';

            try {
                const requestBody = { 
                    query: query,
                    category: category,
                    timeframe: timeframe,
                    source: source
                };

                const response = await fetch('/api/search-news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.articles && data.articles.length > 0) {
                    const newsResults = data.articles.map(article => ({
                        title: article.title || 'No title',
                        link: article.url || '#',
                        description: article.description || article.content || 'No description available',
                        source: article.source?.name || 'News',
                        publishedAt: article.publishedAt,
                        author: article.author,
                        urlToImage: article.urlToImage
                    }));
                    
                    displayNewsResults(newsResults);
                } else {
                    resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">üì∞ No news articles found for your query.</div>';
                }
            } catch (error) {
                console.error('News search error:', error);
                resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">üì∞ News search failed. Please try again.</div>';
            }
        }

        // Advanced analysis function
        async function performAdvancedAnalysis() {
            const query = document.getElementById('universalSearchQuery').value.trim();
            if (!query) {
                alert('Please enter a search query for analysis');
                return;
            }

            const resultsDiv = document.getElementById('eventsResults');
            resultsDiv.innerHTML = '<div class="loading">Performing advanced analysis...</div>';

            try {
                // Get data from both platforms
                const [githubData, redditData] = await Promise.all([
                    searchGitHub(query).catch(() => null),
                    searchReddit(query).catch(() => null)
                ]);

                const analysis = {
                    query,
                    github: {
                        totalRepos: githubData?.total_count || 0,
                        languages: {},
                        averageStars: 0,
                        topRepos: []
                    },
                    reddit: {
                        totalPosts: 0,
                        subreddits: {},
                        averageScore: 0,
                        topPosts: []
                    },
                    correlations: []
                };

                // Analyze GitHub data
                if (githubData && githubData.items) {
                    githubData.items.forEach(repo => {
                        if (repo.language) {
                            analysis.github.languages[repo.language] = (analysis.github.languages[repo.language] || 0) + 1;
                        }
                        analysis.github.averageStars += repo.stargazers_count;
                    });
                    analysis.github.averageStars = Math.round(analysis.github.averageStars / githubData.items.length);
                    analysis.github.topRepos = githubData.items.slice(0, 5);
                }

                // Analyze Reddit data
                if (redditData && redditData.data && redditData.data.children) {
                    analysis.reddit.totalPosts = redditData.data.children.length;
                    redditData.data.children.forEach(post => {
                        const postData = post.data;
                        if (postData.subreddit) {
                            analysis.reddit.subreddits[postData.subreddit] = (analysis.reddit.subreddits[postData.subreddit] || 0) + 1;
                        }
                        analysis.reddit.averageScore += postData.score || 0;
                    });
                    analysis.reddit.averageScore = Math.round(analysis.reddit.averageScore / analysis.reddit.totalPosts);
                    analysis.reddit.topPosts = redditData.data.children.slice(0, 5);
                }

                displayAnalysisResults(analysis);
            } catch (error) {
                console.error('Analysis error:', error);
                resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">Advanced analysis failed.</div>';
            }
        }

        // Display social search results
        function displaySocialResults(results) {
            const resultsDiv = document.getElementById('eventsResults');
            
            if (!results || results.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align: center; color: #666;">No results found across platforms.</div>';
                return;
            }

            const getSourceColor = (source) => {
                switch(source) {
                    case 'GitHub': return 'var(--cyber-green)';
                    case 'Reddit': return 'var(--cyber-orange)';
                    case 'Events': return 'var(--cyber-blue)';
                    case 'News': return 'var(--cyber-pink)';
                    default: return 'var(--cyber-purple)';
                }
            };

            const socialResultsHTML = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 255, 255, 0.1); border-radius: 10px;">
                    <p style="color: var(--cyber-blue); font-weight: bold;">
                        üåê Found ${results.length} results across social platforms
                    </p>
                </div>
                ${results.map((result, index) => {
                    const title = result.title || `Result ${index + 1}`;
                    const link = result.link || '#';
                    const description = result.description || 'No description available';
                    const source = result.source || 'Unknown';
                    
                    let extraInfo = '';
                    if (source === 'GitHub') {
                        extraInfo = `
                            <div style="margin-top: 8px; font-size: 0.8rem;">
                                ${result.stars ? `‚≠ê ${result.stars} stars` : ''} 
                                ${result.language ? `‚Ä¢ üíª ${result.language}` : ''} 
                                ${result.forks ? `‚Ä¢ üç¥ ${result.forks} forks` : ''}
                            </div>
                        `;
                    } else if (source === 'Reddit') {
                        extraInfo = `
                            <div style="margin-top: 8px; font-size: 0.8rem;">
                                üìä ${result.score || 0} points ‚Ä¢ üí¨ ${result.comments || 0} comments ‚Ä¢ üìç r/${result.subreddit || 'unknown'}
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="history-item" style="margin-bottom: 15px; padding: 15px; background: rgba(0, 0, 0, 0.3);">
                            <div class="history-content">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div class="history-query" style="color: var(--cyber-blue); font-size: 1rem; margin-bottom: 5px;">${title}</div>
                                        <span style="color: ${getSourceColor(source)}; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 10px;">
                                            ${source}
                                        </span>
                                    </div>
                                </div>
                                <a href="${link}" target="_blank" style="color: var(--cyber-green); text-decoration: none; font-size: 0.9rem; display: block; margin: 8px 0;">${link}</a>
                                <div style="color: #ccc; font-size: 0.9rem; line-height: 1.4;">${description}</div>
                                ${extraInfo}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            resultsDiv.innerHTML = socialResultsHTML;
        }

        // Display news search results
        function displayNewsResults(results) {
            const resultsDiv = document.getElementById('eventsResults');
            
            if (!results || results.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align: center; color: #666;">üì∞ No news articles found.</div>';
                return;
            }

            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            };

            const newsResultsHTML = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255, 0, 128, 0.1); border-radius: 10px;">
                    <p style="color: var(--cyber-pink); font-weight: bold;">
                        üì∞ Found ${results.length} news articles
                    </p>
                </div>
                ${results.map((article, index) => {
                    const title = article.title || `Article ${index + 1}`;
                    const link = article.link || '#';
                    const description = article.description || 'No description available';
                    const source = article.source || 'News';
                    const publishedAt = article.publishedAt ? formatDate(article.publishedAt) : '';
                    const author = article.author || '';
                    
                    return `
                        <div class="history-item" style="margin-bottom: 15px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-left: 4px solid var(--cyber-pink);">
                            <div class="history-content">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div class="history-query" style="color: var(--cyber-blue); font-size: 1rem; margin-bottom: 5px;">${title}</div>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <span style="color: var(--cyber-pink); font-size: 0.8rem; font-weight: bold; text-transform: uppercase; background: rgba(255,0,128,0.2); padding: 2px 6px; border-radius: 10px;">
                                                üì∞ ${source}
                                            </span>
                                            ${publishedAt ? `<span style="color: var(--cyber-green); font-size: 0.8rem;">üïí ${publishedAt}</span>` : ''}
                                            ${author ? `<span style="color: var(--cyber-orange); font-size: 0.8rem;">‚úçÔ∏è ${author}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <a href="${link}" target="_blank" style="color: var(--cyber-green); text-decoration: none; font-size: 0.9rem; display: block; margin: 8px 0;">${link}</a>
                                <div style="color: #ccc; font-size: 0.9rem; line-height: 1.4;">${description}</div>
                                ${article.urlToImage ? `<div style="margin-top: 10px;"><img src="${article.urlToImage}" alt="Article Image" style="max-width: 100%; height: auto; border-radius: 5px; max-height: 200px;" onerror="this.style.display='none'"></div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            resultsDiv.innerHTML = newsResultsHTML;
        }

        // Display analysis results
        function displayAnalysisResults(analysis) {
            const resultsDiv = document.getElementById('eventsResults');
            
            const analysisHTML = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(139, 0, 255, 0.2); border-radius: 10px; border: 2px solid var(--cyber-purple);">
                    <h3 style="color: var(--cyber-purple); margin-bottom: 10px;">üî¨ Advanced Analysis: "${analysis.query}"</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: rgba(0, 255, 65, 0.1); border: 2px solid var(--cyber-green); border-radius: 10px; padding: 15px;">
                        <h4 style="color: var(--cyber-green); margin-bottom: 10px;">üìä GitHub Analysis</h4>
                        <p>Total Repositories: <strong>${analysis.github.totalRepos}</strong></p>
                        <p>Average Stars: <strong>${analysis.github.averageStars}</strong></p>
                        <p>Top Languages: <strong>${Object.keys(analysis.github.languages).slice(0, 3).join(', ')}</strong></p>
                    </div>
                    
                    <div style="background: rgba(255, 107, 0, 0.1); border: 2px solid var(--cyber-orange); border-radius: 10px; padding: 15px;">
                        <h4 style="color: var(--cyber-orange); margin-bottom: 10px;">üìä Reddit Analysis</h4>
                        <p>Total Posts: <strong>${analysis.reddit.totalPosts}</strong></p>
                        <p>Average Score: <strong>${analysis.reddit.averageScore}</strong></p>
                        <p>Top Subreddits: <strong>${Object.keys(analysis.reddit.subreddits).slice(0, 3).join(', ')}</strong></p>
                    </div>
                </div>
                
                <div style="background: rgba(0, 255, 255, 0.1); border: 2px solid var(--cyber-blue); border-radius: 10px; padding: 15px;">
                    <h4 style="color: var(--cyber-blue); margin-bottom: 15px;">üîç Detailed Insights</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h5 style="color: var(--cyber-green); margin-bottom: 10px;">Top GitHub Repos:</h5>
                            ${analysis.github.topRepos.map(repo => `
                                <div style="margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                    <a href="${repo.html_url}" target="_blank" style="color: var(--cyber-blue); text-decoration: none;">${repo.name}</a>
                                    <div style="font-size: 0.8rem; color: #888;">‚≠ê ${repo.stargazers_count} stars</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div>
                            <h5 style="color: var(--cyber-orange); margin-bottom: 10px;">Top Reddit Posts:</h5>
                            ${analysis.reddit.topPosts.map(post => `
                                <div style="margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                    <a href="https://reddit.com${post.data.permalink}" target="_blank" style="color: var(--cyber-blue); text-decoration: none; font-size: 0.9rem;">${post.data.title.substring(0, 50)}...</a>
                                    <div style="font-size: 0.8rem; color: #888;">üìä ${post.data.score} points ‚Ä¢ r/${post.data.subreddit}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = analysisHTML;
        }

        // Intelligent Search System
        let currentSearchMode = 'auto';

        function setSearchMode(mode) {
            currentSearchMode = mode;
            
            // Update button states
            document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
            const modeButton = document.getElementById(mode + 'Mode');
            if (modeButton) {
                modeButton.classList.add('active');
            }
            
            // Show/hide appropriate sections
            document.querySelectorAll('.search-section').forEach(section => {
                section.style.display = 'none';
            });
            
            if (mode === 'calendar') {
                document.getElementById('calendarSection').style.display = 'block';
                document.getElementById('mainResultsSection').style.display = 'none';
            } else {
                document.getElementById('mainResultsSection').style.display = 'block';
            }
            
            // Update mode indicator
            const indicators = {
                'auto': 'ü§ñ Auto Mode: AI will analyze your query and choose the best search strategy',
                'events': 'üìÖ Events Mode: Focus on local events and activities',
                'github': 'üíª Code Mode: Search GitHub repositories and code-related content',
                'reddit': 'üí¨ Community Mode: Search Reddit posts and discussions',
                'news': 'üì∞ News Mode: Search for latest news and articles',
                'social': 'üåê Social Mode: Search across all social platforms simultaneously',
                'calendar': 'üìÖ Calendar Mode: Access and manage your Google Calendar events'
            };
            
            document.getElementById('modeIndicator').innerHTML = indicators[mode];
            
            // Update search button text
            const buttonTexts = {
                'auto': 'üöÄ Smart Search',
                'events': 'üìÖ Find Events',
                'github': 'üíª Search Code',
                'reddit': 'üí¨ Search Community',
                'news': 'üì∞ Find News',
                'social': 'üåê Search All',
                'calendar': 'üìÖ Open Calendar'
            };
            
            document.getElementById('searchButton').innerHTML = buttonTexts[mode];
        }

        // Function to show and initialize calendar section
        function showCalendarSection() {
            // Initialize Google APIs if not already done
            if (!isGoogleApiLoaded) {
                initializeGoogleApis();
            }
            
            // Show calendar section
            document.getElementById('calendarSection').style.display = 'block';
            document.getElementById('mainResultsSection').style.display = 'none';
            
            // Auto-attempt sign-in if APIs are loaded but user isn't signed in
            setTimeout(() => {
                if (isGoogleApiLoaded && !isGoogleSignedIn) {
                    // Show a more user-friendly message
                    const calendarDiv = document.getElementById('calendarResults') || document.getElementById('eventsResults');
                    if (calendarDiv) {
                        calendarDiv.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <h3 style="color: var(--cyber-green); margin-bottom: 15px;">üìÖ Google Calendar Ready</h3>
                                <p style="color: var(--cyber-blue); margin-bottom: 20px;">Click "Connect Google Calendar" to access your calendars and events</p>
                                <p style="color: #666; font-size: 0.9em;">One-time setup required for calendar access</p>
                            </div>
                        `;
                    }
                }
            }, 1000);
        }

        // AI Query Analysis
        function analyzeQuery(query) {
            const lowercaseQuery = query.toLowerCase();
            
            // Coding/GitHub indicators
            const codingKeywords = [
                'code', 'programming', 'github', 'repository', 'repo', 'javascript', 'python', 'java', 'react', 'node',
                'api', 'library', 'framework', 'algorithm', 'function', 'class', 'method', 'variable', 'syntax',
                'debug', 'error', 'bug', 'compile', 'build', 'deploy', 'git', 'version control', 'open source',
                'npm', 'pip', 'maven', 'gradle', 'docker', 'kubernetes', 'aws', 'cloud', 'database', 'sql',
                'html', 'css', 'typescript', 'angular', 'vue', 'svelte', 'backend', 'frontend', 'fullstack',
                'machine learning', 'ai', 'data science', 'analytics', 'visualization', 'pandas', 'tensorflow'
            ];
            
            // Reddit/Community indicators
            const communityKeywords = [
                'discussion', 'opinion', 'thoughts', 'advice', 'help', 'community', 'reddit', 'forum',
                'question', 'ask', 'share', 'experience', 'story', 'ama', 'til', 'eli5', 'dae',
                'unpopular opinion', 'shower thoughts', 'life pro tip', 'what if', 'how do you',
                'anyone else', 'people', 'users', 'redditors', 'subreddit', 'thread', 'post',
                'upvote', 'downvote', 'karma', 'comment', 'reply', 'meta', 'circlejerk'
            ];
            
            // Events indicators
            const eventKeywords = [
                'event', 'meetup', 'conference', 'workshop', 'seminar', 'festival', 'concert', 'show',
                'happening', 'tonight', 'today', 'weekend', 'location', 'venue', 'tickets', 'rsvp',
                'networking', 'gathering', 'party', 'celebration', 'fair', 'expo', 'convention',
                'live', 'performance', 'exhibition', 'demo', 'presentation', 'talk', 'lecture',
                'near me', 'local', 'nearby', 'this week', 'upcoming', 'schedule', 'calendar'
            ];

            // News indicators
            const newsKeywords = [
                'news', 'breaking', 'latest', 'update', 'report', 'article', 'headline', 'story',
                'current events', 'politics', 'election', 'government', 'world news', 'local news',
                'coronavirus', 'covid', 'economy', 'business', 'technology news', 'sports news',
                'weather', 'climate', 'breaking news', 'developing', 'announcement', 'press release',
                'investigation', 'scandal', 'crisis', 'protest', 'war', 'conflict', 'diplomacy',
                'market', 'stocks', 'finance', 'earnings', 'gdp', 'inflation', 'recession',
                'celebrity', 'entertainment', 'movie', 'tv show', 'music news', 'awards',
                'what happened', 'today\'s news', 'yesterday', 'trending', 'viral'
            ];

            let codeScore = 0;
            let communityScore = 0;
            let eventScore = 0;
            let newsScore = 0;

            // Calculate scores
            codingKeywords.forEach(keyword => {
                if (lowercaseQuery.includes(keyword)) {
                    codeScore += keyword.length > 3 ? 2 : 1;
                }
            });

            communityKeywords.forEach(keyword => {
                if (lowercaseQuery.includes(keyword)) {
                    communityScore += keyword.length > 3 ? 2 : 1;
                }
            });

            eventKeywords.forEach(keyword => {
                if (lowercaseQuery.includes(keyword)) {
                    eventScore += keyword.length > 3 ? 2 : 1;
                }
            });

            newsKeywords.forEach(keyword => {
                if (lowercaseQuery.includes(keyword)) {
                    newsScore += keyword.length > 3 ? 2 : 1;
                }
            });

            // Determine best mode
            const maxScore = Math.max(codeScore, communityScore, eventScore, newsScore);
            
            if (maxScore === 0) {
                return { mode: 'social', confidence: 0.5, reason: 'No specific indicators found, using social mode' };
            }
            
            if (codeScore === maxScore) {
                return { mode: 'github', confidence: codeScore / 10, reason: 'Detected coding/programming content' };
            } else if (communityScore === maxScore) {
                return { mode: 'reddit', confidence: communityScore / 10, reason: 'Detected community discussion content' };
            } else if (newsScore === maxScore) {
                return { mode: 'news', confidence: newsScore / 10, reason: 'Detected news/current events content' };
            } else {
                return { mode: 'events', confidence: eventScore / 10, reason: 'Detected event-related content' };
            }
        }

        // Intelligent Search Function
        async function performIntelligentSearch() {
            const query = document.getElementById('universalSearchQuery').value.trim();
            const location = document.getElementById('universalLocationInput').value.trim();
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const modeIndicator = document.getElementById('modeIndicator');
            const resultsDiv = document.getElementById('eventsResults');
            
            let searchMode = currentSearchMode;
            let analysis = null;

            // Auto mode: analyze query
            if (currentSearchMode === 'auto') {
                modeIndicator.classList.add('detecting');
                modeIndicator.innerHTML = 'ü§ñ Analyzing query...';
                
                analysis = analyzeQuery(query);
                searchMode = analysis.mode;
                
                setTimeout(() => {
                    modeIndicator.classList.remove('detecting');
                    modeIndicator.innerHTML = `üéØ Auto-detected: ${analysis.mode.toUpperCase()} mode (${(analysis.confidence * 100).toFixed(0)}% confidence) - ${analysis.reason}`;
                }, 1000);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // Save search to history
            const eventsCount = 0; // Will be updated after search
            const newsCount = 0;
            saveSearch(query, eventsCount, newsCount);

            // Execute search based on determined mode
            try {
                switch (searchMode) {
                    case 'github':
                        resultsDiv.innerHTML = '<div class="loading">üîç Searching GitHub repositories...</div>';
                        await searchGitHubOnly();
                        break;
                    
                    case 'reddit':
                        resultsDiv.innerHTML = '<div class="loading">üîç Searching Reddit discussions...</div>';
                        await searchRedditOnly();
                        break;
                    
                    case 'events':
                        if (!location) {
                            document.getElementById('universalLocationInput').focus();
                            alert('Please enter a location for event search');
                            return;
                        }
                        resultsDiv.innerHTML = '<div class="loading">üîç Searching for events...</div>';
                        // Copy location to the detailed event search input and trigger search
                        document.getElementById('locationInput').value = location;
                        await searchEvents();
                        break;
                    
                    case 'news':
                        resultsDiv.innerHTML = '<div class="loading">üì∞ Searching latest news...</div>';
                        await searchNewsOnly(query);
                        break;
                    
                    case 'social':
                        resultsDiv.innerHTML = '<div class="loading">üîç Searching all platforms...</div>';
                        await generalSearch();
                        break;
                    
                    default:
                        resultsDiv.innerHTML = '<div class="loading">üîç Performing comprehensive search...</div>';
                        await generalSearch();
                }
                
                // Show analysis results if auto mode was used
                if (currentSearchMode === 'auto' && analysis) {
                    const analysisDiv = document.createElement('div');
                    analysisDiv.innerHTML = `
                        <div style="background: rgba(0, 255, 255, 0.1); border: 2px solid var(--cyber-blue); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: var(--cyber-blue); margin-bottom: 10px;">ü§ñ AI Analysis Results</h4>
                            <p><strong>Detected Mode:</strong> ${searchMode.toUpperCase()}</p>
                            <p><strong>Confidence:</strong> ${(analysis.confidence * 100).toFixed(0)}%</p>
                            <p><strong>Reasoning:</strong> ${analysis.reason}</p>
                        </div>
                    `;
                    resultsDiv.insertBefore(analysisDiv, resultsDiv.firstChild);
                }
                
            } catch (error) {
                console.error('Intelligent search error:', error);
                resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">Search failed. Please try again.</div>';
            }
        }
        // Create floating particles
        function createParticles() {
            const particleContainer = document.getElementById('particles');
            const colors = ['#00ffff', '#ff0080', '#00ff41', '#ff6b00', '#8b00ff'];
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particleContainer.appendChild(particle);
            }
        }

        // Global variables for current data and tab management
        let currentEventsData = null;
        let currentActiveTab = 'events';

        // Tab switching functionality
        function switchTab(tabName) {
            currentActiveTab = tabName;
            
            // Update tab buttons
            document.getElementById('eventsTab').style.background = tabName === 'events' ? 'var(--cyber-blue)' : 'rgba(0, 255, 255, 0.2)';
            document.getElementById('eventsTab').style.color = tabName === 'events' ? 'black' : 'var(--cyber-blue)';
            document.getElementById('newsTab').style.background = tabName === 'news' ? 'var(--cyber-blue)' : 'rgba(0, 255, 255, 0.2)';
            document.getElementById('newsTab').style.color = tabName === 'news' ? 'black' : 'var(--cyber-blue)';
            
            // Show/hide content
            document.getElementById('eventsContent').style.display = tabName === 'events' ? 'block' : 'none';
            document.getElementById('newsContent').style.display = tabName === 'news' ? 'block' : 'none';
            
            // If we have current data, re-display it for the active tab
            if (currentEventsData) {
                displaySeparatedResults(currentEventsData);
            }
        }

        // Enhanced sorting function
        function sortEvents(events, sortBy) {
            return [...events].sort((a, b) => {
                switch(sortBy) {
                    case 'date':
                        return new Date(a.date || 0) - new Date(b.date || 0);
                    case 'popularity':
                        return (b.attendees || 0) - (a.attendees || 0);
                    case 'source':
                        const sourceQuality = {'Ticketmaster': 5, 'Eventbrite': 4, 'NewsAPI': 3, 'OpenWeather': 2, 'API-Ninja': 1};
                        return (sourceQuality[b.source] || 0) - (sourceQuality[a.source] || 0);
                    case 'price':
                        const aFree = a.isFree || a.price === 'Free' || !a.price;
                        const bFree = b.isFree || b.price === 'Free' || !b.price;
                        if (aFree && !bFree) return -1;
                        if (!aFree && bFree) return 1;
                        return 0;
                    case 'relevance':
                    default:
                        return (b.relevanceScore || b.confidence || 0) - (a.relevanceScore || a.confidence || 0);
                }
            });
        }

        // Filter events based on focus
        function filterEvents(events, focus) {
            return events.filter(event => {
                switch(focus) {
                    case 'today':
                        const today = new Date().toDateString();
                        return event.date && new Date(event.date).toDateString() === today;
                    case 'free':
                        return event.isFree || event.price === 'Free' || !event.price;
                    case 'ticketed':
                        return !event.isFree && event.price && event.price !== 'Free';
                    case 'nearby':
                        return event.coordinates || event.location;
                    case 'all':
                    default:
                        return true;
                }
            });
        }

        // Comprehensive Search Function - Uses All APIs
        async function performComprehensiveSearch() {
            // Handle calendar mode specially
            if (currentSearchMode === 'calendar') {
                showCalendarSection();
                return;
            }
            
            const query = document.getElementById('universalSearchQuery').value.trim();
            const location = document.getElementById('universalLocationInput').value.trim();
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const resultsDiv = document.getElementById('eventsResults');
            resultsDiv.innerHTML = '<div class="loading">üöÄ Searching across all platforms and APIs...</div>';

            try {
                // Determine search mode based on current selection or auto-detect
                let searchMode = currentSearchMode;
                if (currentSearchMode === 'auto') {
                    const analysis = analyzeQuery(query);
                    searchMode = analysis.mode;
                    
                    // Show analysis results
                    setTimeout(() => {
                        resultsDiv.innerHTML = `
                            <div class="loading">
                                ü§ñ AI detected: ${analysis.mode.toUpperCase()} mode (${Math.round(analysis.confidence * 100)}% confidence)<br>
                                ${analysis.reason}<br><br>
                                üîç Searching across all APIs...
                            </div>
                        `;
                    }, 500);
                }

                // Create search promises for all relevant APIs
                const searchPromises = [];

                // Always search events if location is provided or if it's event mode
                if (location || searchMode === 'events') {
                    searchPromises.push(
                        fetch(`/api/search-events?location=${encodeURIComponent(location || query)}&genre=${encodeURIComponent(query)}`)
                            .then(res => res.json())
                            .then(data => ({ type: 'events', data }))
                            .catch(err => ({ type: 'events', error: err.message }))
                    );
                }

                // Always search news
                searchPromises.push(
                    fetch('/api/search-news', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query })
                    })
                        .then(res => res.json())
                        .then(data => ({ type: 'news', data }))
                        .catch(err => ({ type: 'news', error: err.message }))
                );

                // Search GitHub if relevant
                if (searchMode === 'github' || searchMode === 'auto' || searchMode === 'social') {
                    searchPromises.push(
                        searchGitHub(query)
                            .then(data => ({ type: 'github', data }))
                            .catch(err => ({ type: 'github', error: err.message }))
                    );
                }

                // Search Reddit if relevant
                if (searchMode === 'reddit' || searchMode === 'auto' || searchMode === 'social') {
                    searchPromises.push(
                        searchReddit(query)
                            .then(data => ({ type: 'reddit', data }))
                            .catch(err => ({ type: 'reddit', error: err.message }))
                    );
                }

                // Execute all searches in parallel
                const results = await Promise.allSettled(searchPromises);
                
                // Process and combine results
                displayComprehensiveResults(results, query, location, searchMode);

            } catch (error) {
                console.error('Comprehensive search error:', error);
                resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">Search failed. Please try again.</div>';
            }
        }

        // Display comprehensive results from all APIs
        function displayComprehensiveResults(results, query, location, searchMode) {
            const resultsDiv = document.getElementById('eventsResults');
            let allResults = [];
            let eventCount = 0;
            let newsCount = 0;
            let githubCount = 0;
            let redditCount = 0;

            // Process each result type
            results.forEach(result => {
                if (result.status === 'fulfilled' && result.value && !result.value.error) {
                    const { type, data } = result.value;
                    
                    switch(type) {
                        case 'events':
                            if (data.events && data.events.length > 0) {
                                eventCount = data.events.length;
                                data.events.forEach(event => {
                                    allResults.push({
                                        type: 'event',
                                        title: event.title || event.name,
                                        description: event.description || event.summary,
                                        link: event.url || event.link,
                                        venue: event.venue || event.location,
                                        date: event.date || event.start_date,
                                        source: 'Events API'
                                    });
                                });
                            }
                            break;

                        case 'news':
                            if (data.articles && data.articles.length > 0) {
                                newsCount = data.articles.length;
                                data.articles.forEach(article => {
                                    allResults.push({
                                        type: 'news',
                                        title: article.title,
                                        description: article.description,
                                        link: article.url,
                                        source: article.source?.name || 'News',
                                        date: article.publishedAt,
                                        author: article.author
                                    });
                                });
                            }
                            break;

                        case 'github':
                            if (data.items && data.items.length > 0) {
                                githubCount = data.items.length;
                                data.items.forEach(repo => {
                                    allResults.push({
                                        type: 'github',
                                        title: repo.full_name,
                                        description: repo.description,
                                        link: repo.html_url,
                                        source: 'GitHub',
                                        stars: repo.stargazers_count,
                                        language: repo.language
                                    });
                                });
                            }
                            break;

                        case 'reddit':
                            if (data.data && data.data.children) {
                                redditCount = data.data.children.length;
                                data.data.children.forEach(post => {
                                    const postData = post.data;
                                    allResults.push({
                                        type: 'reddit',
                                        title: postData.title,
                                        description: postData.selftext || `r/${postData.subreddit}`,
                                        link: postData.url.startsWith('http') ? postData.url : `https://reddit.com${postData.permalink}`,
                                        source: 'Reddit',
                                        subreddit: postData.subreddit,
                                        score: postData.score
                                    });
                                });
                            }
                            break;
                    }
                }
            });

            // Generate comprehensive results HTML
            const summaryHTML = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 255, 255, 0.1); border-radius: 10px;">
                    <h3 style="color: var(--cyber-blue); margin-bottom: 10px;">üöÄ Comprehensive Search Results</h3>
                    <p style="color: var(--cyber-green); font-weight: bold;">
                        Found ${allResults.length} total results for "${query}"${location ? ` in ${location}` : ''}
                    </p>
                    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                        ${eventCount > 0 ? `<span style="color: var(--cyber-blue);">üé™ ${eventCount} Events</span>` : ''}
                        ${newsCount > 0 ? `<span style="color: var(--cyber-pink);">üì∞ ${newsCount} News</span>` : ''}
                        ${githubCount > 0 ? `<span style="color: var(--cyber-green);">üíª ${githubCount} GitHub</span>` : ''}
                        ${redditCount > 0 ? `<span style="color: var(--cyber-orange);">üí¨ ${redditCount} Reddit</span>` : ''}
                    </div>
                </div>
            `;

            if (allResults.length === 0) {
                resultsDiv.innerHTML = summaryHTML + '<p style="text-align: center; color: #666;">No results found across all platforms.</p>';
                return;
            }

            // Sort results by relevance/type
            allResults.sort((a, b) => {
                const typeOrder = { 'event': 1, 'news': 2, 'github': 3, 'reddit': 4 };
                return typeOrder[a.type] - typeOrder[b.type];
            });

            const resultItems = allResults.map(result => {
                const typeColors = {
                    'event': 'var(--cyber-blue)',
                    'news': 'var(--cyber-pink)',
                    'github': 'var(--cyber-green)',
                    'reddit': 'var(--cyber-orange)'
                };

                const typeIcons = {
                    'event': 'üé™',
                    'news': 'üì∞',
                    'github': 'üíª',
                    'reddit': 'üí¨'
                };

                return `
                    <div class="history-item" style="margin-bottom: 15px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-left: 4px solid ${typeColors[result.type]};">
                        <div class="history-content">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div class="history-query" style="color: var(--cyber-blue); font-size: 1rem; margin-bottom: 5px;">${result.title}</div>
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                                        <span style="color: ${typeColors[result.type]}; font-size: 0.8rem; font-weight: bold; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 10px;">
                                            ${typeIcons[result.type]} ${result.source}
                                        </span>
                                        ${result.date ? `<span style="color: var(--cyber-green); font-size: 0.8rem;">üìÖ ${new Date(result.date).toLocaleDateString()}</span>` : ''}
                                        ${result.venue ? `<span style="color: var(--cyber-orange); font-size: 0.8rem;">üìç ${result.venue}</span>` : ''}
                                        ${result.stars ? `<span style="color: var(--cyber-green); font-size: 0.8rem;">‚≠ê ${result.stars}</span>` : ''}
                                        ${result.score ? `<span style="color: var(--cyber-orange); font-size: 0.8rem;">üëç ${result.score}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            ${result.link ? `<a href="${result.link}" target="_blank" style="color: var(--cyber-green); text-decoration: none; font-size: 0.9rem; display: block; margin: 8px 0; word-break: break-all;">${result.link}</a>` : ''}
                            <div style="color: #ccc; font-size: 0.9rem; line-height: 1.4;">${result.description || 'No description available'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            resultsDiv.innerHTML = summaryHTML + resultItems;
            
            // Save to search history with correct counts
            saveComprehensiveSearchToHistory(query, location, searchMode, eventCount, newsCount, githubCount, redditCount, allResults);
        }

        // Enhanced search function
        async function searchEvents() {
            const location = document.getElementById('locationInput').value.trim();
            const genre = document.getElementById('genreSelect').value;
            const eventType = document.getElementById('eventTypeSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            const radius = document.getElementById('radiusInput').value || 25;
            
            if (!location) {
                alert('Please enter a location');
                return;
            }

            const resultsDiv = document.getElementById('eventsResults');
            resultsDiv.innerHTML = '<div class="loading">üîç Scanning event networks...</div>';

            try {
                // Enhanced API now uses GET with query parameters
                const queryParams = new URLSearchParams({
                    location: location,
                    genre: genre,
                    timeframe: timeframe
                });

                const response = await fetch(`/api/search-events?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Search results:', data); // Debug log
                
                // Display results directly in eventsResults div
                displayEventResults(data);
                
                // Save the search
                await saveEventSearch(data);
            } catch (error) {
                console.error('Event search error:', error);
                resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">Event search failed. Check network connection.</div>';
            }
        }

        // Simple event results display function
        function displayEventResults(data) {
            const resultsDiv = document.getElementById('eventsResults');
            const events = data.events || data.results || [];
            const location = data.metadata?.location || data.location || 'Unknown Location';
            
            if (!events || events.length === 0) {
                resultsDiv.innerHTML = `<p style="text-align: center; color: #666;">No events found for "${location}"</p>`;
                return;
            }

            const eventsHTML = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 255, 255, 0.1); border-radius: 10px;">
                    <p style="color: var(--cyber-blue); font-weight: bold;">
                        üé™ Found ${events.length} events in ${location}
                    </p>
                </div>
                ${events.map((event, index) => {
                    const title = event.title || event.name || `Event ${index + 1}`;
                    const description = event.description || event.summary || 'No description available';
                    const venue = event.venue || event.location || 'Venue TBD';
                    const date = event.date || event.start_date || event.datetime || 'Date TBD';
                    const link = event.url || event.link || '#';
                    
                    return `
                        <div class="history-item" style="margin-bottom: 15px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-left: 4px solid var(--cyber-blue);">
                            <div class="history-content">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div class="history-query" style="color: var(--cyber-blue); font-size: 1rem; margin-bottom: 5px;">${title}</div>
                                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                                            <span style="color: var(--cyber-green); font-size: 0.8rem;">üìÖ ${date}</span>
                                            <span style="color: var(--cyber-orange); font-size: 0.8rem;">üìç ${venue}</span>
                                            ${event.price ? `<span style="color: var(--cyber-pink); font-size: 0.8rem;">üí∞ ${event.price}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                ${link !== '#' ? `<a href="${link}" target="_blank" style="color: var(--cyber-green); text-decoration: none; font-size: 0.9rem; display: block; margin: 8px 0;">${link}</a>` : ''}
                                <div style="color: #ccc; font-size: 0.9rem; line-height: 1.4;">${description}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            resultsDiv.innerHTML = eventsHTML;
        }

        // Real-time event discovery function
        async function discoverEventsNow() {
            const location = document.getElementById('locationInput').value.trim();
            const genre = document.getElementById('genreInput').value.trim() || 'events';
            
            if (!location) {
                alert('Please enter a location for real-time discovery');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">üîç Discovering events happening now...</div>';

            try {
                // Use the working enhanced API endpoint
                const queryParams = new URLSearchParams({
                    location: location,
                    genre: genre,
                    timeframe: 'immediate'
                });

                const response = await fetch(`/api/search-events?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Discover Now results:', data); // Debug log
                
                // Store the data globally and display in tabs
                currentEventsData = data;
                displaySeparatedResults(data);
                
                // Save the discovery
                await saveEventSearch(data);
            } catch (error) {
                console.error('Real-time discovery error:', error);
                resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">Real-time discovery failed. Check network connection.</div>';
            }
        }

        // Display enhanced search results
        function displayEnhancedResults(data) {
            const resultsDiv = document.getElementById('results');
            
            // Enhanced server returns 'events' not 'results'
            const events = data.events || data.results || [];
            const location = data.metadata?.location || data.location || 'Unknown Location';
            const genre = data.metadata?.genre || data.genre || '';
            
            console.log('Displaying results:', { events: events.length, data }); // Debug log
            
            if (!events || events.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; color: #666;">
                        <p>No events found for "${location}"</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Try a different location or genre.</p>
                    </div>`;
                return;
            }

            const header = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 255, 255, 0.1); border-radius: 10px;">
                    <p style="color: var(--cyber-blue); font-weight: bold;">
                        üìç Found ${data.totalFound || events.length} events in ${location}
                        ${genre && genre !== 'any' ? ` ‚Ä¢ ${genre}` : ''}
                    </p>
                    <p style="color: #888; font-size: 0.9rem;">
                        API Sources: ${data.apiSources ? data.apiSources.join(', ') : 'Multiple APIs'} | Quality: ${data.searchQuality || 'Enhanced'}
                    </p>
                </div>
            `;

            // Display the events using the enhanced format
            const eventsHTML = events.slice(0, 20).map(event => `
                <div class="result-item" style="background: rgba(0, 255, 255, 0.05); border: 1px solid var(--cyber-blue); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div class="result-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h3 style="color: var(--cyber-blue); margin: 0; flex-grow: 1;">${event.title}</h3>
                        <div style="text-align: right; margin-left: 15px;">
                            <span style="background: var(--cyber-pink); color: black; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">${event.source || 'API'}</span>
                            ${event.category ? `<br><span style="color: var(--cyber-orange); font-size: 0.8rem;">${event.category}</span>` : ''}
                        </div>
                    </div>
                    <p style="color: #ccc; margin: 10px 0;">${event.description || 'Event details coming soon'}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <div>
                            <span style="color: var(--cyber-green);">üìç ${event.location || location}</span>
                            ${event.date ? `<br><span style="color: var(--cyber-orange);">üóìÔ∏è ${new Date(event.date).toLocaleDateString()}</span>` : ''}
                        </div>
                        <div style="text-align: right;">
                            ${event.price ? `<span style="color: var(--cyber-yellow);">üí∞ ${event.price}</span><br>` : ''}
                            ${event.url ? `<a href="${event.url}" target="_blank" style="color: var(--cyber-pink); text-decoration: none;">View Details ‚Üí</a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            resultsDiv.innerHTML = header + eventsHTML;
        }

        // Display real-time discovery results
        function displayRealTimeResults(data) {
            const resultsDiv = document.getElementById('results');
            
            if (!data.results || data.results.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; color: #666;">
                        <p>No immediate events found in "${data.location}"</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Try expanding your search radius or check back later.</p>
                    </div>`;
                return;
            }

            const header = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255, 107, 0, 0.2); border-radius: 10px; border: 2px solid var(--cyber-orange);">
                    <p style="color: var(--cyber-orange); font-weight: bold; font-size: 1.1rem;">
                        üö® REAL-TIME DISCOVERY: ${data.location}
                    </p>
                    <p style="color: var(--cyber-blue);">
                        Found ${data.summary.total} events ‚Ä¢ Immediate: ${data.summary.immediate} ‚Ä¢ Tonight: ${data.summary.tonight}
                    </p>
                    <p style="color: #888; font-size: 0.9rem;">
                        Searched ${data.meta.queriesExecuted} sources ‚Ä¢ Confidence: ${(data.summary.avgConfidence * 100).toFixed(0)}%
                    </p>
                </div>
            `;

            // Group results by time relevance
            const categorizedHTML = generateRealTimeCategorizedHTML(data.categorized, data.summary);

            resultsDiv.innerHTML = header + categorizedHTML;
        }

        // Generate categorized HTML for enhanced results
        function generateCategorizedHTML(categorized, allResults) {
            let html = '';
            
            const categories = [
                { key: 'immediate', title: 'üî• Happening Now', color: 'var(--cyber-orange)' },
                { key: 'upcoming', title: '‚ö° Coming Soon', color: 'var(--cyber-pink)' },
                { key: 'general', title: 'üìÖ General Events', color: 'var(--cyber-blue)' },
                { key: 'reference', title: 'üìö Event Directories', color: 'var(--cyber-purple)' }
            ];

            // Show categorized results if available
            if (categorized && Object.keys(categorized).length > 0) {
                categories.forEach(category => {
                    const events = categorized[category.key] || [];
                    if (events.length > 0) {
                        html += `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: ${category.color}; margin-bottom: 15px; font-family: 'Orbitron', monospace; border-bottom: 2px solid ${category.color}; padding-bottom: 5px;">
                                    ${category.title} (${events.length})
                                </h3>
                                ${events.map(event => generateEventHTML(event)).join('')}
                            </div>
                        `;
                    }
                });
            } else {
                // Fallback to all results
                html = allResults.map(event => generateEventHTML(event)).join('');
            }

            return html;
        }

        // Generate real-time categorized HTML
        function generateRealTimeCategorizedHTML(categorized, summary) {
            let html = '';
            
            const categories = [
                { key: 'immediate', title: 'üö® RIGHT NOW', color: 'var(--cyber-orange)', urgent: true },
                { key: 'tonight', title: 'üåô TONIGHT', color: 'var(--cyber-pink)', urgent: true },
                { key: 'thisWeek', title: 'üìÖ THIS WEEK', color: 'var(--cyber-blue)', urgent: false },
                { key: 'ongoing', title: 'üîÑ ONGOING', color: 'var(--cyber-green)', urgent: false }
            ];

            categories.forEach(category => {
                const events = categorized[category.key] || [];
                if (events.length > 0) {
                    html += `
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: ${category.color}; margin-bottom: 15px; font-family: 'Orbitron', monospace; border-bottom: 2px solid ${category.color}; padding-bottom: 5px; ${category.urgent ? 'animation: pulse 2s infinite;' : ''}">
                                ${category.title} (${events.length})
                            </h3>
                            ${events.map(event => generateEventHTML(event, category.urgent)).join('')}
                        </div>
                    `;
                }
            });

            return html;
        }

        // Generate individual event HTML
        function generateEventHTML(event, isUrgent = false) {
            const urgencyBorder = isUrgent ? '3px solid var(--cyber-orange)' : '1px solid var(--cyber-blue)';
            const urgencyGlow = isUrgent ? 'box-shadow: 0 0 15px rgba(255, 107, 0, 0.5);' : '';
            
            return `
                <div class="result-item" style="border-left: 4px solid ${getEventTypeColor(event.eventType)}; border: ${urgencyBorder}; ${urgencyGlow}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div class="result-title" style="flex: 1;">${event.title || 'Event'}</div>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <span style="background: ${getEventTypeColor(event.eventType)}; color: black; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
                                ${event.source}
                            </span>
                            <span style="background: var(--cyber-purple); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">
                                ${event.eventType}
                            </span>
                            ${event.urgency === 'immediate' ? '<span style="background: var(--cyber-orange); color: black; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; animation: pulse 1s infinite;">NOW</span>' : ''}
                            ${event.confidence ? `<span style="background: var(--cyber-green); color: black; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">${(event.confidence * 100).toFixed(0)}%</span>` : ''}
                        </div>
                    </div>
                    <a href="${event.url}" target="_blank" class="result-link">${event.url}</a>
                    <div class="result-snippet">${event.description}</div>
                    <div style="display: flex; gap: 15px; margin-top: 8px; font-size: 0.8rem;">
                        ${event.category ? `<span style="color: var(--cyber-green);">üìÇ ${event.category}</span>` : ''}
                        ${event.extractedDate ? `<span style="color: var(--cyber-blue);">üìÖ ${event.extractedDate}</span>` : ''}
                        ${event.extractedTime ? `<span style="color: var(--cyber-pink);">üïê ${event.extractedTime}</span>` : ''}
                        ${event.urgency ? `<span style="color: var(--cyber-orange);">‚ö° ${event.urgency}</span>` : ''}
                    </div>
                </div>
            `;
        }

        // Get color for event type
        function getEventTypeColor(type) {
            const colors = {
                'ticketed': '#ff6b00',
                'community': '#00ff41', 
                'social': '#ff0080',
                'general': '#00ffff'
            };
            return colors[type] || '#00ffff';
        }

        // Save event search
        async function saveEventSearch(searchData) {
            try {
                await fetch('/api/save-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: `${searchData.location} - ${searchData.genre || 'any'} - ${searchData.eventType || 'any'}`,
                        results: searchData.results
                    })
                });
            } catch (error) {
                console.error('Failed to save search:', error);
            }
        }

        // Save comprehensive search to history with correct counts
        async function saveComprehensiveSearchToHistory(query, location, searchMode, eventCount, newsCount, githubCount, redditCount, allResults) {
            try {
                // Save to localStorage for immediate display
                const searches = getSearchHistory();
                const newSearch = {
                    id: Date.now(),
                    query: query,
                    location: location || '',
                    searchMode: searchMode || 'auto',
                    timestamp: new Date().toISOString(),
                    eventsFound: eventCount,
                    newsFound: newsCount,
                    githubFound: githubCount || 0,
                    redditFound: redditCount || 0,
                    totalResults: eventCount + newsCount + (githubCount || 0) + (redditCount || 0)
                };
                
                searches.unshift(newSearch);
                
                // Keep only latest 50 searches
                if (searches.length > 50) {
                    searches.splice(50);
                }
                
                localStorage.setItem('prospectorSearchHistory', JSON.stringify(searches));
                loadSearchHistory();
                updateSearchStats();

                // Save to database if user is authenticated
                if (currentUser) {
                    console.log('üîê Attempting to save search for authenticated user:', currentUser.username);
                    try {
                        // Clean and format results for database storage
                        const formattedResults = (allResults || []).map(result => ({
                            title: result.title || 'Untitled',
                            description: result.description || '',
                            url: result.link || result.url || '', // Use link or url, fallback to empty string
                            source: result.source || 'Unknown',
                            metadata: {
                                type: result.type,
                                date: result.date,
                                venue: result.venue,
                                stars: result.stars,
                                score: result.score,
                                subreddit: result.subreddit,
                                language: result.language,
                                author: result.author
                            }
                        }));

                        const response = await fetch('/api/save-search', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                query: query,
                                location: location || '',
                                searchMode: searchMode || 'auto',
                                results: formattedResults,
                                resultCounts: {
                                    events: eventCount,
                                    news: newsCount,
                                    github: githubCount || 0,
                                    reddit: redditCount || 0,
                                    total: eventCount + newsCount + (githubCount || 0) + (redditCount || 0)
                                }
                            })
                        });
                        
                        if (response.ok) {
                            console.log(`‚úÖ Search saved to database for user: ${currentUser.username}`);
                        } else {
                            console.log('‚ùå Failed to save search to database');
                        }
                    } catch (dbError) {
                        console.log('üìù Database save failed:', dbError.message);
                    }
                } else {
                    console.log('üë§ Guest user - search saved to localStorage only. currentUser:', currentUser);
                }

            } catch (error) {
                console.error('Failed to save search to history:', error);
            }
        }

        // Load nearby events using geolocation
        async function loadNearbyEvents() {
            if (!navigator.geolocation) {
                alert('Geolocation not supported by your browser');
                return;
            }

            const resultsDiv = document.getElementById('eventsResults');
            resultsDiv.innerHTML = '<div class="loading">üìç Getting your location...</div>';

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                // Try to get a readable address using reverse geocoding
                try {
                    const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                    const data = await response.json();
                    const address = data.city && data.countryName ? `${data.city}, ${data.countryName}` : `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
                    document.getElementById('locationInput').value = address;
                } catch (error) {
                    // Fallback to coordinates if geocoding fails
                    document.getElementById('locationInput').value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                }
                
                resultsDiv.innerHTML = '<div class="loading">üîç Finding nearby events...</div>';
                await searchEvents();
            }, (error) => {
                resultsDiv.innerHTML = '<div style="color: var(--cyber-pink); text-align: center;">Location access denied. Please enter location manually.</div>';
            });
        }

        // Clear results
        function clearResults() {
            document.getElementById('eventsResults').innerHTML = '<p style="text-align: center; color: #666;">Enter location and preferences to discover live events...</p>';
            document.getElementById('locationInput').value = '';
            document.getElementById('genreSelect').value = '';
            document.getElementById('eventTypeSelect').value = '';
            document.getElementById('timeframeSelect').value = 'upcoming';
            document.getElementById('radiusInput').value = '25';
        }

        // Handle Enter key for location input
        document.getElementById('locationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchEvents();
            }
        });

        // Handle Enter key for radius input
        document.getElementById('radiusInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchEvents();
            }
        });

        // New function to display results separated by events and news
        function displaySeparatedResults(data) {
            const events = data.events || data.results || [];
            const location = data.metadata?.location || data.location || 'Unknown Location';
            
            console.log('Displaying separated results:', { events: events.length, activeTab: currentActiveTab });
            
            if (!events || events.length === 0) {
                const message = `<p style="text-align: center; color: #666;">No ${currentActiveTab} found for "${location}"</p>`;
                document.getElementById(currentActiveTab + 'Results').innerHTML = message;
                return;
            }

            // Get sorting and filtering preferences
            const sortBy = document.getElementById('sortBy').value;
            const focus = document.getElementById('eventFocus').value;

            // Separate events from news
            const liveEvents = events.filter(event => 
                event.type !== 'news-event' && 
                event.type !== 'news-style' &&
                event.source !== 'NewsAPI'
            );
            
            const newsEvents = events.filter(event => 
                event.type === 'news-event' || 
                event.type === 'news-style' ||
                event.source === 'NewsAPI'
            );

            // Apply sorting and filtering
            const sortedLiveEvents = sortEvents(filterEvents(liveEvents, focus), sortBy);
            const sortedNewsEvents = sortEvents(filterEvents(newsEvents, focus), sortBy);

            // Display based on active tab
            if (currentActiveTab === 'events') {
                displayEventsTab(sortedLiveEvents, data);
            } else {
                displayNewsTab(sortedNewsEvents, data);
            }
        }

        // Display live events tab
        function displayEventsTab(events, originalData) {
            const location = originalData.metadata?.location || originalData.location || 'Unknown Location';
            const genre = originalData.metadata?.genre || originalData.genre || '';

            const header = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 255, 255, 0.1); border-radius: 10px;">
                    <p style="color: var(--cyber-blue); font-weight: bold;">
                        üé™ Found ${events.length} live events in ${location}
                        ${genre ? ` ‚Ä¢ ${genre}` : ''}
                    </p>
                    <p style="color: #888; font-size: 0.9rem;">
                        Live Events ‚Ä¢ Sorted by ${document.getElementById('sortBy').value}
                    </p>
                </div>
            `;

            const eventsHTML = events.slice(0, 20).map(event => `
                <div class="result-item" style="background: rgba(0, 255, 255, 0.05); border: 1px solid var(--cyber-blue); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div class="result-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h3 style="color: var(--cyber-blue); margin: 0; flex-grow: 1;">${event.title}</h3>
                        <div style="text-align: right; margin-left: 15px;">
                            <span style="background: var(--cyber-green); color: black; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">${event.source || 'EVENT'}</span>
                            ${event.category ? `<br><span style="color: var(--cyber-orange); font-size: 0.8rem;">${event.category}</span>` : ''}
                            ${event.isFree ? `<br><span style="color: var(--cyber-green); font-size: 0.8rem;">FREE</span>` : ''}
                        </div>
                    </div>
                    <p style="color: #ccc; margin: 10px 0;">${event.description || 'Event details coming soon'}</p>
                    
                    <!-- Enhanced Location Information -->
                    <div style="background: rgba(0, 255, 0, 0.1); border: 1px solid var(--cyber-green); border-radius: 5px; padding: 10px; margin: 10px 0;">
                        ${event.venue ? `<div style="color: var(--cyber-green); font-weight: bold; margin-bottom: 5px;">üè¢ ${event.venue}</div>` : ''}
                        <div style="color: var(--cyber-green); display: flex; align-items: center;">
                            <span style="margin-right: 8px;">üìç</span>
                            <span style="font-family: monospace;">${event.address || event.location || location}</span>
                        </div>
                        ${event.coordinates ? `
                            <div style="color: #888; font-size: 0.8rem; margin-top: 5px;">
                                ÔøΩÔ∏è ${event.coordinates.lat.toFixed(4)}, ${event.coordinates.lng.toFixed(4)}
                                <a href="https://maps.google.com/?q=${event.coordinates.lat},${event.coordinates.lng}" target="_blank" style="color: var(--cyber-pink); margin-left: 10px;">View on Maps</a>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <div>
                            ${event.date ? `<span style="color: var(--cyber-orange);">üóìÔ∏è ${new Date(event.date).toLocaleDateString()} at ${new Date(event.date).toLocaleTimeString()}</span><br>` : ''}
                            ${event.attendees ? `<span style="color: var(--cyber-blue);">üë• ${event.attendees} attending</span>` : ''}
                        </div>
                        <div style="text-align: right;">
                            ${event.price && event.price !== 'Free' ? `<span style="color: var(--cyber-yellow);">üí∞ ${event.price}</span><br>` : ''}
                            ${event.url ? `<a href="${event.url}" target="_blank" style="color: var(--cyber-pink); text-decoration: none;">View Event ‚Üí</a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('eventsResults').innerHTML = header + eventsHTML;
        }

        // Display news tab
        function displayNewsTab(newsEvents, originalData) {
            const location = originalData.metadata?.location || originalData.location || 'Unknown Location';

            const header = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255, 165, 0, 0.1); border-radius: 10px;">
                    <p style="color: var(--cyber-orange); font-weight: bold;">
                        üì∞ Found ${newsEvents.length} event news articles for ${location}
                    </p>
                    <p style="color: #888; font-size: 0.9rem;">
                        Event News & Announcements ‚Ä¢ Sorted by ${document.getElementById('sortBy').value}
                    </p>
                </div>
            `;

            const newsHTML = newsEvents.slice(0, 15).map(article => `
                <div class="result-item" style="background: rgba(255, 165, 0, 0.05); border: 1px solid var(--cyber-orange); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div class="result-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h3 style="color: var(--cyber-orange); margin: 0; flex-grow: 1;">${article.title}</h3>
                        <div style="text-align: right; margin-left: 15px;">
                            <span style="background: var(--cyber-orange); color: black; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">NEWS</span>
                            ${article.publisher ? `<br><span style="color: var(--cyber-blue); font-size: 0.8rem;">${article.publisher}</span>` : ''}
                        </div>
                    </div>
                    <p style="color: #ccc; margin: 10px 0;">${article.description || 'Event news and announcements'}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <div>
                            <span style="color: var(--cyber-green);">üìç ${article.location || location}</span>
                            ${article.date ? `<br><span style="color: var(--cyber-orange);">üìÖ ${new Date(article.date).toLocaleDateString()}</span>` : ''}
                        </div>
                        <div style="text-align: right;">
                            ${article.url ? `<a href="${article.url}" target="_blank" style="color: var(--cyber-pink); text-decoration: none;">Read Article ‚Üí</a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('newsResults').innerHTML = header + newsHTML;
        }

        // Sidebar Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const burger = document.querySelector('.burger-menu');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('open');
            burger.classList.toggle('open');
            overlay.classList.toggle('open');
            
            if (sidebar.classList.contains('open')) {
                loadSearchHistory();
                updateSearchStats();
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const burger = document.querySelector('.burger-menu');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.remove('open');
            burger.classList.remove('open');
            overlay.classList.remove('open');
        }

        // Search History Management
        function saveSearch(query, eventsCount, newsCount) {
            const searches = getSearchHistory();
            const newSearch = {
                id: Date.now(),
                query: query,
                eventsCount: eventsCount,
                newsCount: newsCount,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            searches.unshift(newSearch);
            
            // Keep only last 50 searches
            if (searches.length > 50) {
                searches.splice(50);
            }
            
            localStorage.setItem('prospectorSearchHistory', JSON.stringify(searches));
        }

        function getSearchHistory() {
            const history = localStorage.getItem('prospectorSearchHistory');
            return history ? JSON.parse(history) : [];
        }

        async function loadSearchHistory() {
            const localSearches = getSearchHistory();
            const historyContainer = document.getElementById('searchHistory');
            
            console.log('üìö Loading search history. currentUser:', currentUser ? currentUser.username : 'none');
            
            // Try to load database searches if user is authenticated
            let databaseSearches = [];
            if (currentUser) {
                try {
                    console.log('üîç Fetching user searches from database...');
                    const response = await fetch('/api/user/searches?limit=10', {
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        databaseSearches = data.searches;
                        console.log('‚úÖ Loaded', databaseSearches.length, 'searches from database');
                    } else {
                        console.log('‚ùå Failed to load database searches:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.log('‚ùå Error loading database searches:', error.message);
                }
            }

            // Combine and deduplicate searches
            const allSearches = [...databaseSearches, ...localSearches];
            const uniqueSearches = allSearches.filter((search, index, self) => 
                index === self.findIndex(s => s.query === search.query && 
                    Math.abs(new Date(s.timestamp || s.createdAt) - new Date(search.timestamp || search.createdAt)) < 60000)
            ).slice(0, 20);
            
            if (uniqueSearches.length === 0) {
                historyContainer.innerHTML = `
                    <div style="color: #666; text-align: center; padding: 20px;">
                        <p>No searches yet</p>
                        ${databaseSearches.length === 0 ? '<p style="font-size: 0.8rem; margin-top: 10px;">üîê Login to save searches permanently</p>' : ''}
                    </div>`;
                return;
            }
            
            const historyHTML = uniqueSearches.map(search => {
                const isFromDatabase = search._id; // Database searches have _id
                const date = new Date(search.timestamp || search.createdAt);
                const eventsCount = search.eventsFound || search.resultCounts?.events || 0;
                const newsCount = search.newsFound || search.resultCounts?.news || 0;
                const totalCount = search.totalResults || search.resultCounts?.total || (eventsCount + newsCount);
                
                return `
                    <div class="history-item">
                        <div class="history-content" onclick="repeatSearch('${search.query}')">
                            <div class="history-query">${search.query}${search.location ? ` in ${search.location}` : ''}</div>
                            <div class="history-date">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                            <div class="history-results">
                                üìÖ ${eventsCount} events ‚Ä¢ üì∞ ${newsCount} news
                                ${search.resultCounts?.github ? ` ‚Ä¢ üíª ${search.resultCounts.github} repos` : ''}
                                ${search.resultCounts?.reddit ? ` ‚Ä¢ ÔøΩ ${search.resultCounts.reddit} posts` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            ${isFromDatabase ? `
                                <div class="preview-btn" onclick="previewSearch('${search._id}')" title="Preview search results">
                                    üëÅÔ∏è
                                </div>
                                <div class="delete-btn" onclick="deleteDBSearch('${search._id}')" title="Delete this search">
                                    üóëÔ∏è
                                </div>
                            ` : `
                                <div class="delete-btn" onclick="deleteHistoryItem(${search.id})" title="Delete this search">
                                    üóëÔ∏è
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            
            historyContainer.innerHTML = historyHTML;
        }

        function updateSearchStats() {
            const searches = getSearchHistory();
            const totalSearches = searches.length;
            const totalEvents = searches.reduce((sum, search) => sum + (search.eventsFound || 0), 0);
            const totalNews = searches.reduce((sum, search) => sum + (search.newsFound || 0), 0);
            
            document.getElementById('totalSearches').textContent = totalSearches;
            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('totalNews').textContent = totalNews;
        }

        function repeatSearch(query) {
            document.getElementById('queryInput').value = query;
            closeSidebar();
            search();
        }

        function deleteHistoryItem(searchId) {
            const searches = getSearchHistory();
            const updatedSearches = searches.filter(search => search.id !== searchId);
            localStorage.setItem('prospectorSearchHistory', JSON.stringify(updatedSearches));
            loadSearchHistory();
            updateSearchStats();
        }

        // Open Calendar Mode from sidebar
        async function openCalendarMode() {
            closeSidebar();
            setSearchMode('calendar');
            
            // Try to initialize Google APIs when calendar is accessed
            if (!isGoogleApiLoaded) {
                const resultsDiv = document.getElementById('eventsResults');
                resultsDiv.innerHTML = `
                    <div class="result-item" style="border-color: var(--cyber-blue);">
                        <div class="result-title">üîÑ Initializing Google Calendar API...</div>
                        <div style="margin: 15px 0; color: var(--cyber-blue);">
                            Please wait while we connect to Google Calendar services.
                        </div>
                    </div>
                `;
                
                try {
                    await initializeGoogleApis();
                    resultsDiv.innerHTML = `
                        <div class="result-item" style="border-color: var(--cyber-green);">
                            <div class="result-title">‚úÖ Google Calendar API Ready</div>
                            <div style="margin: 15px 0; color: var(--cyber-green);">
                                Click "Connect Google Calendar" to sign in and access your calendars.
                            </div>
                        </div>
                    `;
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="result-item" style="border-color: var(--cyber-pink);">
                            <div class="result-title">‚ùå Calendar API Initialization Failed</div>
                            <div style="margin: 15px 0; color: var(--cyber-pink);">
                                ${error.message}
                            </div>
                            <div style="color: #666; font-size: 0.9em;">
                                Please check your internet connection and API credentials.
                            </div>
                        </div>
                    `;
                }
            }
        }

        function clearSearchHistory() {
            if (confirm('Are you sure you want to clear all search history?')) {
                localStorage.removeItem('prospectorSearchHistory');
                loadSearchHistory();
                updateSearchStats();
            }
        }

        // ==================== AUTHENTICATION FUNCTIONS ====================

        let currentUser = null;

        // Check authentication status on page load
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateUIForAuthenticatedUser();
                } else {
                    currentUser = null;
                    updateUIForGuestUser();
                }
            } catch (error) {
                console.log('Auth check failed:', error);
                currentUser = null;
                updateUIForGuestUser();
            }
        }

        // Update UI for authenticated user
        function updateUIForAuthenticatedUser() {
            document.getElementById('guestControls').style.display = 'none';
            document.getElementById('userControls').style.display = 'flex';
            document.getElementById('userWelcome').textContent = `Welcome, ${currentUser.firstName || currentUser.username}!`;
            
            // Add debug info
            console.log('‚úÖ User authenticated:', {
                id: currentUser._id,
                username: currentUser.username,
                email: currentUser.email
            });
        }

        // Update UI for guest user
        function updateUIForGuestUser() {
            document.getElementById('guestControls').style.display = 'flex';
            document.getElementById('userControls').style.display = 'none';
        }

        // Show login form
        function showLoginForm() {
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('profileForm').style.display = 'none';
            document.getElementById('changePasswordForm').style.display = 'none';
        }

        // Show register form
        function showRegisterForm() {
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('profileForm').style.display = 'none';
            document.getElementById('changePasswordForm').style.display = 'none';
        }

        // Show profile form
        function showProfileForm() {
            if (!currentUser) {
                showLoginForm();
                return;
            }
            
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('profileForm').style.display = 'block';
            document.getElementById('changePasswordForm').style.display = 'none';
            
            // Populate form with current user data
            document.getElementById('profileFirstName').value = currentUser.firstName || '';
            document.getElementById('profileLastName').value = currentUser.lastName || '';
            document.getElementById('profileDefaultLocation').value = currentUser.preferences?.defaultLocation || '';
            document.getElementById('profileEmailNotifications').checked = currentUser.preferences?.emailNotifications !== false;
        }

        // Show change password form
        function showChangePassword() {
            document.getElementById('profileForm').style.display = 'none';
            document.getElementById('changePasswordForm').style.display = 'block';
        }

        // Switch between login and register
        function switchToLogin() {
            showLoginForm();
        }

        function switchToRegister() {
            showRegisterForm();
        }

        // Close modal
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            // Clear all forms
            document.querySelectorAll('#authModal form').forEach(form => form.reset());
        }

        // Login function
        async function login(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    updateUIForAuthenticatedUser();
                    closeAuthModal();
                    showNotification('üéâ Login successful! Welcome back, agent.', 'success');
                } else {
                    showNotification(`‚ùå ${data.error}`, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Login failed. Check your connection.', 'error');
            }
        }

        // Register function
        async function register(event) {
            event.preventDefault();
            
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, email, password, firstName, lastName })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    updateUIForAuthenticatedUser();
                    closeAuthModal();
                    showNotification('üéâ Registration successful! Welcome to the network, agent.', 'success');
                } else {
                    showNotification(`‚ùå ${data.error}`, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Registration failed. Check your connection.', 'error');
            }
        }

        // Update profile function
        async function updateProfile(event) {
            event.preventDefault();
            
            const firstName = document.getElementById('profileFirstName').value;
            const lastName = document.getElementById('profileLastName').value;
            const defaultLocation = document.getElementById('profileDefaultLocation').value;
            const emailNotifications = document.getElementById('profileEmailNotifications').checked;
            
            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        preferences: {
                            defaultLocation,
                            emailNotifications
                        }
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    updateUIForAuthenticatedUser();
                    closeAuthModal();
                    showNotification('‚úÖ Profile updated successfully!', 'success');
                } else {
                    showNotification(`‚ùå ${data.error}`, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Profile update failed. Check your connection.', 'error');
            }
        }

        // Change password function
        async function changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showNotification('‚ùå New passwords do not match!', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    closeAuthModal();
                    showNotification('üîí Password changed successfully!', 'success');
                } else {
                    showNotification(`‚ùå ${data.error}`, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Password change failed. Check your connection.', 'error');
            }
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    currentUser = null;
                    updateUIForGuestUser();
                    showNotification('üëã Logged out successfully. Stay safe out there, agent.', 'success');
                } else {
                    showNotification('‚ùå Logout failed', 'error');
                }
            } catch (error) {
                showNotification('‚ùå Logout failed. Check your connection.', 'error');
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-family: 'Orbitron', monospace;
                font-weight: bold;
                z-index: 10000;
                max-width: 400px;
                word-wrap: break-word;
                background: ${type === 'success' ? 'linear-gradient(45deg, var(--cyber-green), var(--cyber-blue))' : 
                           type === 'error' ? 'linear-gradient(45deg, var(--cyber-pink), var(--cyber-orange))' :
                           'linear-gradient(45deg, var(--cyber-blue), var(--cyber-purple))'};
                border: 2px solid ${type === 'success' ? 'var(--cyber-green)' : 
                                  type === 'error' ? 'var(--cyber-pink)' : 'var(--cyber-blue)'};
                animation: slideInRight 0.3s ease-out;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        // Add notification animations to CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { opacity: 0; transform: translateX(100%); }
                to { opacity: 1; transform: translateX(0); }
            }
            @keyframes slideOutRight {
                from { opacity: 1; transform: translateX(0); }
                to { opacity: 0; transform: translateX(100%); }
            }
        `;
        document.head.appendChild(style);

        // ==================== END AUTHENTICATION FUNCTIONS ====================

        // Handle Enter key for universal search input
        document.getElementById('universalSearchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performComprehensiveSearch();
            }
        });

        // Handle Enter key for search input
        const socialSearchElement = document.getElementById('socialSearchQuery');
        if (socialSearchElement) {
            socialSearchElement.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    generalSearch();
                }
            });
        }

        // ==================== SEARCH PREVIEW FUNCTIONS ====================

        // Preview search results
        async function previewSearch(searchId) {
            try {
                const response = await fetch(`/api/search/${searchId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load search preview');
                }
                
                const searchData = await response.json();
                showPreviewModal(searchData);
                
            } catch (error) {
                console.error('Preview error:', error);
                alert('Failed to load search preview: ' + error.message);
            }
        }

        // Show preview modal with search data
        function showPreviewModal(searchData) {
            const modal = document.getElementById('previewModal');
            const detailsDiv = document.getElementById('previewDetails');
            const resultsDiv = document.getElementById('previewResults');
            
            // Format search details
            const date = new Date(searchData.createdAt);
            const detailsHTML = `
                <div style="background: rgba(0, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: var(--cyber-green); margin: 0 0 10px 0;">"${searchData.query}"</h3>
                    ${searchData.location ? `<p style="color: var(--cyber-orange); margin: 5px 0;"><strong>üìç Location:</strong> ${searchData.location}</p>` : ''}
                    <p style="color: var(--cyber-blue); margin: 5px 0;"><strong>üïí Search Date:</strong> ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</p>
                    <p style="color: var(--cyber-pink); margin: 5px 0;"><strong>üéØ Mode:</strong> ${searchData.searchMode || 'auto'}</p>
                    <div style="display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                        ${searchData.resultCounts.events > 0 ? `<span style="color: var(--cyber-blue);">üé™ ${searchData.resultCounts.events} Events</span>` : ''}
                        ${searchData.resultCounts.news > 0 ? `<span style="color: var(--cyber-pink);">üì∞ ${searchData.resultCounts.news} News</span>` : ''}
                        ${searchData.resultCounts.github > 0 ? `<span style="color: var(--cyber-green);">üíª ${searchData.resultCounts.github} GitHub</span>` : ''}
                        ${searchData.resultCounts.reddit > 0 ? `<span style="color: var(--cyber-orange);">üí¨ ${searchData.resultCounts.reddit} Reddit</span>` : ''}
                    </div>
                </div>
            `;
            
            // Format results
            const resultsHTML = searchData.results.map(result => {
                const typeColors = {
                    'event': 'var(--cyber-blue)',
                    'news': 'var(--cyber-pink)',
                    'github': 'var(--cyber-green)',
                    'reddit': 'var(--cyber-orange)'
                };
                
                const typeIcons = {
                    'event': 'üé™',
                    'news': 'üì∞',
                    'github': 'üíª',
                    'reddit': 'üí¨'
                };
                
                return `
                    <div class="preview-result-item" style="border-left-color: ${typeColors[result.type] || 'var(--cyber-green)'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--cyber-blue); margin: 0 0 5px 0; font-size: 1rem;">${result.title}</h4>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                                    <span style="color: ${typeColors[result.type] || 'var(--cyber-green)'}; font-size: 0.8rem; font-weight: bold; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 10px;">
                                        ${typeIcons[result.type] || 'üîç'} ${result.source}
                                    </span>
                                    ${result.metadata?.date ? `<span style="color: var(--cyber-green); font-size: 0.8rem;">üìÖ ${new Date(result.metadata.date).toLocaleDateString()}</span>` : ''}
                                    ${result.metadata?.venue ? `<span style="color: var(--cyber-orange); font-size: 0.8rem;">üìç ${result.metadata.venue}</span>` : ''}
                                    ${result.metadata?.stars ? `<span style="color: var(--cyber-green); font-size: 0.8rem;">‚≠ê ${result.metadata.stars}</span>` : ''}
                                    ${result.metadata?.score ? `<span style="color: var(--cyber-orange); font-size: 0.8rem;">üëç ${result.metadata.score}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        ${result.url ? `<a href="${result.url}" target="_blank" style="color: var(--cyber-green); text-decoration: none; font-size: 0.9rem; display: block; margin: 8px 0; word-break: break-all;">${result.url}</a>` : ''}
                        <div style="color: #ccc; font-size: 0.9rem; line-height: 1.4;">${result.description || 'No description available'}</div>
                    </div>
                `;
            }).join('');
            
            detailsDiv.innerHTML = detailsHTML;
            resultsDiv.innerHTML = resultsHTML || '<p style="text-align: center; color: #666;">No results available</p>';
            
            modal.classList.add('show');
        }

        // Close preview modal
        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            modal.classList.remove('show');
        }

        // Delete database search
        async function deleteDBSearch(searchId) {
            if (!confirm('Are you sure you want to delete this search?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/search/${searchId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete search');
                }
                
                // Reload search history
                loadSearchHistory();
                
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete search: ' + error.message);
            }
        }

        // Click outside to close preview modal
        document.getElementById('previewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePreviewModal();
            }
        });

        // ==================== END SEARCH PREVIEW FUNCTIONS ====================

        // Initialize
        createParticles();
        checkAuthStatus(); // Check if user is logged in
        loadSearchHistory();
        updateSearchStats();
        
        // Add some sample history if none exists
        const existingHistory = getSearchHistory();
        if (existingHistory.length === 0) {
            // Add sample searches to demonstrate the feature with new format
            const sampleSearches = [
                { query: "music festivals", eventsFound: 12, newsFound: 8 },
                { query: "tech meetups", eventsFound: 7, newsFound: 5 },
                { query: "food events", eventsFound: 15, newsFound: 3 }
            ];
            
            sampleSearches.forEach((search, index) => {
                const timestamp = new Date();
                timestamp.setHours(timestamp.getHours() - (index + 1));
                
                const newSearch = {
                    id: Date.now() + index,
                    query: search.query,
                    location: '',
                    timestamp: timestamp.toISOString(),
                    eventsFound: search.eventsFound,
                    newsFound: search.newsFound,
                    githubFound: 0,
                    redditFound: 0,
                    totalResults: search.eventsFound + search.newsFound
                };
                
                const searches = getSearchHistory();
                searches.unshift(newSearch);
                localStorage.setItem('prospectorSearchHistory', JSON.stringify(searches));
            });
            
            loadSearchHistory();
            updateSearchStats();
        }

        // Initialize particles and other UI elements when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('The Prospector loaded - Google Calendar API will initialize when accessed');
        });
    </script>
</body>
</html>